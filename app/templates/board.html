{# app/templates/board.html #}

{% extends "base.html" %}
{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h1>{{ board.name }} <small class="text-muted fs-6">(–í–ª–∞–¥–µ–ª–µ—Ü: {{ board.owner.username }})</small></h1>
    <div> 
        {% if current_user.can_delete_board(board) %}
        <a href="{{ url_for('edit_board', board_id=board.id) }}" class="btn btn-outline-secondary me-2">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–æ—Å–∫–∏</a>
        {% endif %}
        <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">–ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É –¥–æ—Å–æ–∫</a>
    </div>
</div>

<!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–∞–º–∏ (—Ç–æ–ª—å–∫–æ –¥–ª—è –≤–ª–∞–¥–µ–ª—å—Ü–∞) -->
{% if is_owner %}
<div class="card mb-4">
    <div class="card-header">
        –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–∞–º–∏
    </div>
    <div class="card-body">
        <h5>–ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h5>
        <form action="{{ url_for('invite_to_board', board_id=board.id) }}" method="post" novalidate class="row g-3 align-items-end">
            {{ invite_form.hidden_tag() }}
            <div class="col-md-6">
                {{ invite_form.email_or_username.label(class="form-label") }}
                {{ invite_form.email_or_username(class="form-control form-control-sm" + (" is-invalid" if invite_form.email_or_username.errors else "")) }}
                {% if invite_form.email_or_username.errors %}
                    <div class="invalid-feedback d-block">
                        {% for error in invite_form.email_or_username.errors %}<span>{{ error }}</span><br>{% endfor %}
                    </div>
                {% endif %}
            </div>
            <div class="col-auto">
                {{ invite_form.submit_invite(class="btn btn-sm btn-success") }}
            </div>
        </form>
        <hr>
        <h5>–¢–µ–∫—É—â–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏ –∏ –≤–ª–∞–¥–µ–ª–µ—Ü:</h5>
         <ul class="list-group list-group-flush">
             <li class="list-group-item d-flex justify-content-between align-items-center">
                <img src="{{ board.owner.get_avatar() }}" alt="–ê–≤–∞—Ç–∞—Ä {{ board.owner.username }}" class="rounded-circle me-2" style="width: 30px; height: 30px; object-fit: cover;" title="{{ board.owner.username }}">
                {{ board.owner.username }} ({{ board.owner.email }})
                <span class="badge bg-primary">–í–ª–∞–¥–µ–ª–µ—Ü</span>
             </li>
            {% set owner_id = board.owner.id %}
            {% for member in board_members %}
                {% if member.id != owner_id %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                        <img src="{{ member.get_avatar() }}" alt="–ê–≤–∞—Ç–∞—Ä {{ member.username }}" class="rounded-circle me-2" style="width: 30px; height: 30px; object-fit: cover;" title="{{ member.username }}">
                        {{ member.username }} ({{ member.email }})
                    </div>
                    <form action="{{ url_for('remove_from_board', board_id=board.id, user_id=member.id) }}" method="post" onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å {{ member.username }} —Å —ç—Ç–æ–π –¥–æ—Å–∫–∏?');" class="d-inline">
                         <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <button type="submit" class="btn btn-sm btn-outline-warning">–£–¥–∞–ª–∏—Ç—å</button>
                    </form>
                </li>
                {% endif %}
            {% endfor %}
            {% if not board_members or (board_members|length == 1 and board_members[0].id == owner_id and board_members[0] == board.owner) %}
                 <li class="list-group-item text-muted">–î—Ä—É–≥–∏—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –Ω–µ—Ç.</li>
            {% endif %}
        </ul>
    </div>
</div>
{% elif board_members or board.owner %} 
    <div class="card mb-4">
        <div class="card-header">
            –£—á–∞—Å—Ç–Ω–∏–∫–∏ –¥–æ—Å–∫–∏
        </div>
         <div class="card-body">
            <ul class="list-group list-group-flush">
                 <li class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                        <img src="{{ board.owner.get_avatar() }}" alt="–ê–≤–∞—Ç–∞—Ä {{ board.owner.username }}" class="rounded-circle me-2" style="width: 30px; height: 30px; object-fit: cover;" title="{{ board.owner.username }}">
                        {{ board.owner.username }}
                    </div>
                    <span class="badge bg-primary">–í–ª–∞–¥–µ–ª–µ—Ü</span>
                 </li>
                 {% set owner_id = board.owner.id %}
                 {% for member in board_members %}
                      {% if member.id != owner_id %}
                      <li class="list-group-item d-flex justify-content-between align-items-center">
                          <div>
                            <img src="{{ member.get_avatar() }}" alt="–ê–≤–∞—Ç–∞—Ä {{ member.username }}" class="rounded-circle me-2" style="width: 30px; height: 30px; object-fit: cover;" title="{{ member.username }}">
                            {{ member.username }}
                          </div>
                          {% if member == current_user %}
                              <form action="{{ url_for('remove_from_board', board_id=board.id, user_id=member.id) }}" method="post" onsubmit="return confirm('–ü–æ–∫–∏–Ω—É—Ç—å –¥–æ—Å–∫—É {{ board.name }}?');" class="d-inline">
                                   <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                  <button type="submit" class="btn btn-sm btn-outline-warning">–ü–æ–∫–∏–Ω—É—Ç—å –¥–æ—Å–∫—É</button>
                              </form>
                          {% else %}
                             <span class="badge bg-secondary">–£—á–∞—Å—Ç–Ω–∏–∫</span>
                          {% endif %}
                      </li>
                      {% endif %}
                 {% endfor %}
            </ul>
        </div>
    </div>
{% endif %}


<div class="container-fluid px-0">
    <div class="row flex-nowrap overflow-auto pb-3" id="boardColumnsContainer">
        {% for column in columns %}
        <div class="col-md-4 col-lg-3 column-drag-container">
            <div class="card bg-light mb-3 h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 me-2 text-truncate" title="{{ column.name }}">{{ column.name }}</h5>
                    {% if current_user.can_edit_board(board) %}
                    <div class="d-flex align-items-center">
                         <a href="{{ url_for('edit_column', column_id=column.id) }}" class="btn btn-sm btn-outline-secondary border-0 p-1 me-1" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ–ª–æ–Ω–∫—É">‚úèÔ∏è</a>
                         <form action="{{ url_for('delete_column', column_id=column.id) }}" method="post" onsubmit="return confirm('–£–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∫–æ–ª–æ–Ω–∫—É \'{{ column.name }}\'? –í—Å–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –≤ –Ω–µ–π –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã!');" class="d-inline">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <button type="submit" class="btn btn-sm btn-outline-danger border-0 p-1" title="–£–¥–∞–ª–∏—Ç—å –∫–æ–ª–æ–Ω–∫—É">‚úñ</button>
                        </form>
                    </div>
                    {% endif %}
                </div>
                <div class="card-body d-flex flex-column">
                    <div class="list-group list-group-flush mb-3 flex-grow-1 card-list" id="column-{{ column.id }}" data-column-id="{{ column.id }}">
                        {% for card in column.cards.all() %}
                        {# –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ–± –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è—Ö –¥–ª—è data-–∞—Ç—Ä–∏–±—É—Ç–∞ #}
                        {% set card_assignees_json = [] %}
                        {% for assignee in card.assignees.all() %}
                            {% set _ = card_assignees_json.append({'id': assignee.id, 'username': assignee.username, 'avatar_url': assignee.get_avatar()}) %}
                        {% endfor %}
                        <div class="list-group-item list-group-item-action card-item-clickable py-2 px-3 draggable-card"
                             data-bs-toggle="modal"
                             data-bs-target="#cardDetailModal"
                             data-card-id="{{ card.id }}"
                             data-card-title="{{ card.title }}"
                             data-card-description="{{ card.description or '' }}"
                             data-edit-url="{{ url_for('edit_card', card_id=card.id) }}"
                             data-delete-url="{{ url_for('delete_card', card_id=card.id) }}"
                             data-card-assignees='{{ card_assignees_json|tojson }}' {# JSON —Å–ø–∏—Å–æ–∫ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π, –æ–±–µ—Ä–Ω—É—Ç—ã–π –≤ –æ–¥–∏–Ω–∞—Ä–Ω—ã–µ –∫–∞–≤—ã—á–∫–∏ #}
                             id="card-{{ card.id }}">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1 card-title-display">{{ card.title }}</h6>
                            </div>
                            <div class="card-details-display mt-1">
                                {% if card.description %}
                                    <small class="text-muted card-description-indicator me-2" title="–ï—Å—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ">üìÑ</small>
                                {% endif %}
                                <div class="card-assignees-list d-inline-flex align-items-center">
                                    {% if card.assignees.all() %}
                                        {% for assignee in card.assignees.all() %}
                                        <img src="{{ assignee.get_avatar() }}" alt="{{ assignee.username }}" class="rounded-circle card-assignee-avatar" title="{{ assignee.username }}" style="width: 24px; height: 24px; object-fit: cover; margin-right: -8px; border: 1px solid white;">
                                        {% endfor %}
                                    {% else %}
                                         <small class="text-muted fst-italic no-assignee-placeholder">–ù–µ—Ç –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π</small>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% else %}
                            <div class="list-group-item text-muted small fst-italic no-cards-placeholder">–ù–µ—Ç –∫–∞—Ä—Ç–æ—á–µ–∫</div>
                        {% endfor %}
                    </div>
                    {% if current_user.can_edit_board(board) %}
                    <form action="{{ url_for('create_card', column_id=column.id) }}" method="post" novalidate class="mt-auto add-card-form">
                        {{ card_form.hidden_tag() }}
                        <div class="mb-2">
                             {{ card_form.title.label(class="form-label visually-hidden") }}
                            {{ card_form.title(class="form-control form-control-sm", placeholder="–ù–æ–≤–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞...", aria_label="–ó–∞–≥–æ–ª–æ–≤–æ–∫ –∫–∞—Ä—Ç–æ—á–∫–∏") }}
                        </div>
                         {{ card_form.description(style="display:none;") }}
                         {{ card_form.assignees(style="display:none;") }} {# –°–∫—Ä—ã—Ç–æ, –¥–ª—è –±—ã—Å—Ç—Ä–æ–π —Ñ–æ—Ä–º—ã –Ω–µ –≤—ã–±–∏—Ä–∞–µ–º #}
                        {{ card_form.submit_card(class="btn btn-sm btn-outline-primary w-100", value="+ –î–æ–±–∞–≤–∏—Ç—å") }}
                         {% if card_form.errors and request.form.get('column_id') == column.id|string %}
                              <div class="mt-2 text-danger small">
                                  {% for field, error_list in card_form.errors.items() %}
                                      {% if field != 'csrf_token' %}
                                         {% for error in error_list %}{{error}}<br>{% endfor %}
                                      {% endif %}
                                  {% endfor %}
                              </div>
                         {% endif %}
                    </form>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}

        {% if current_user.can_edit_board(board) %}
        <div class="col-md-4 col-lg-3">
            <div class="card bg-light">
                <div class="card-body">
                    <form action="{{ url_for('view_board', board_id=board.id) }}" method="post" novalidate>
                        {{ column_form.hidden_tag() }}
                         <div class="mb-2">
                            {{ column_form.name.label(class="form-label visually-hidden") }}
                            {{ column_form.name(class="form-control form-control-sm" + (" is-invalid" if column_form.name.errors else ""), placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–π –∫–æ–ª–æ–Ω–∫–∏") }}
                            {% if column_form.name.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in column_form.name.errors %}<span>{{ error }}</span><br>{% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        <input type="hidden" name="submit_column" value="1"> {# –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –¥–ª—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ –≤ view_board #}
                        {{ column_form.submit_column(class="btn btn-primary btn-sm w-100", value="–î–æ–±–∞–≤–∏—Ç—å –∫–æ–ª–æ–Ω–∫—É") }}
                    </form>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–µ—Ç–∞–ª–µ–π/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–∞—Ä—Ç–æ—á–∫–∏ -->
<div class="modal fade" id="cardDetailModal" tabindex="-1" aria-labelledby="cardDetailModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="cardDetailModalLabel">–î–µ—Ç–∞–ª–∏ –∫–∞—Ä—Ç–æ—á–∫–∏</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="editCardFormModal" method="post" action="">
            {{ card_form.hidden_tag() }}
            <div class="mb-3">
                {{ card_form.title.label(for="modalCardTitle", class="form-label") }}
                {{ card_form.title(class="form-control", id="modalCardTitle", required=True, maxlength=150) }}
                 <div class="invalid-feedback" id="modalTitleError"></div>
            </div>
            <div class="mb-3">
                 {{ card_form.description.label(for="modalCardDescription", class="form-label") }}
                 {{ card_form.description(class="form-control", id="modalCardDescription", rows=5, maxlength=1000) }}
                 <div class="invalid-feedback" id="modalDescriptionError"></div>
            </div>
            <div class="mb-3">
                {{ card_form.assignees.label(for="modalCardAssignees", class="form-label") }}
                {# –≠—Ç–æ—Ç —Å–µ–ª–µ–∫—Ç –±—É–¥–µ—Ç SelectMultipleField. Bootstrap –¥–æ–ª–∂–µ–Ω –µ–≥–æ —Å—Ç–∏–ª–∏–∑–æ–≤–∞—Ç—å –Ω–æ—Ä–º–∞–ª—å–Ω–æ #}
                {# Choices –¥–ª—è —ç—Ç–æ–≥–æ —Å–µ–ª–µ–∫—Ç–∞ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –≤ card_form —á–µ—Ä–µ–∑ _populate_assignee_choices #}
                {{ card_form.assignees(class="form-select", id="modalCardAssignees", multiple="multiple", style="min-height: 100px;") }}
                <div class="form-text">–£–¥–µ—Ä–∂–∏–≤–∞–π—Ç–µ Ctrl (–∏–ª–∏ Cmd –Ω–∞ Mac) –¥–ª—è –≤—ã–±–æ—Ä–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π.</div>
                <div class="invalid-feedback" id="modalAssigneesError"></div>
            </div>
            <div id="modalSelectedAssigneesPreview" class="mb-3 d-flex flex-wrap align-items-center">
                <!-- –ê–≤–∞—Ç–∞—Ä–∫–∏ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π –±—É–¥—É—Ç –∑–¥–µ—Å—å -->
            </div>
            <input type="submit" name="submit_card" style="display:none;">
        </form>
      </div>
      <div class="modal-footer justify-content-between">
        <div>
            <form id="deleteCardFormModal" method="post" action="" class="d-inline">
                 <input type="hidden" name="csrf_token" value="">
                 <button type="submit" class="btn btn-danger" onclick="return confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –∫–∞—Ä—Ç–æ—á–∫—É?');">–£–¥–∞–ª–∏—Ç—å</button>
            </form>
        </div>
        <div>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
            <button type="button" class="btn btn-primary" id="saveCardModalBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js" integrity="sha512-Eezs+g9Lq4TCCq0wae01s9PuNWzHYoCMkE97e2qdkYthpI0pzC3UGB03lgEHn2XM85hDOUF6qgqqszs+iXU4UA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    var cardDetailModalEl = document.getElementById('cardDetailModal');
    var cardModal = bootstrap.Modal.getInstance(cardDetailModalEl) || new bootstrap.Modal(cardDetailModalEl);

    // –û–±—â–∏–π CSRF —Ç–æ–∫–µ–Ω –¥–ª—è AJAX –∑–∞–ø—Ä–æ—Å–æ–≤ (–µ—Å–ª–∏ –Ω—É–∂–µ–Ω –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ)
    // –î–ª—è FormData –æ–Ω –æ–±—ã—á–Ω–æ –Ω–µ –Ω—É–∂–µ–Ω –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ, –µ—Å–ª–∏ –µ—Å—Ç—å hidden input –≤ —Ñ–æ—Ä–º–µ
    var csrfTokenGlobal = document.querySelector('meta[name="csrf-token"]'); // –ï—Å–ª–∏ –±—ã –æ–Ω –±—ã–ª –≤ –º–µ—Ç–∞-—Ç–µ–≥–µ
    // –ü—Ä–æ—â–µ –≤–∑—è—Ç—å –∏–∑ –ª—é–±–æ–π —Ñ–æ—Ä–º—ã –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
    var anyFormWithCsrf = document.querySelector('form input[name="csrf_token"]');
    var csrfToken = anyFormWithCsrf ? anyFormWithCsrf.value : null;
    if (!csrfToken) {
        console.error("CSRF Token not found on the page for AJAX!");
    }


    if (cardDetailModalEl) {
        var modalForm = document.getElementById('editCardFormModal');
        var modalTitleField = document.getElementById('modalCardTitle');
        var modalDescriptionField = document.getElementById('modalCardDescription');
        var modalAssigneesSelect = document.getElementById('modalCardAssignees');
        var modalSelectedAssigneesPreview = document.getElementById('modalSelectedAssigneesPreview');
        var modalLabel = document.getElementById('cardDetailModalLabel');
        var deleteForm = document.getElementById('deleteCardFormModal');
        var saveButton = document.getElementById('saveCardModalBtn');

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–µ–≤—å—é –∞–≤–∞—Ç–∞—Ä–æ–∫ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
        function updateModalAssigneesPreview() {
            modalSelectedAssigneesPreview.innerHTML = ''; // –û—á–∏—Å—Ç–∏—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–∏–µ
            const selectedOptions = Array.from(modalAssigneesSelect.selectedOptions);
            if (selectedOptions.length > 0) {
                 const titleEl = document.createElement('small');
                 titleEl.className = 'me-2 text-muted d-block w-100 mb-1';
                 titleEl.textContent = '–í—ã–±—Ä–∞–Ω–Ω—ã–µ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–∏:';
                 modalSelectedAssigneesPreview.appendChild(titleEl);
            }
            selectedOptions.forEach(option => {
                // –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ –∞–≤–∞—Ç–∞—Ä–∫—É –∏–∑ data-–∞—Ç—Ä–∏–±—É—Ç–∞ –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—É—é
                // –≠—Ç–æ –ª—É—á—à–µ –¥–µ–ª–∞—Ç—å, –µ—Å–ª–∏ —É –Ω–∞—Å –µ—Å—Ç—å –ø–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ —é–∑–µ—Ä–æ–≤ —Å –∞–≤–∞—Ç–∞—Ä–∫–∞–º–∏ –≤ JS
                // –ü–æ–∫–∞ –ø—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∂–µ–º –∏–º—è
                const assigneeId = option.value;
                const assigneeName = option.text;

                // –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ –∞–≤–∞—Ç–∞—Ä–∫—É –∏–∑ –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞ (–µ—Å–ª–∏ –±—ã –æ–Ω –±—ã–ª)
                // let avatarUrl = –≥–ª–æ–±–∞–ª—å–Ω—ã–π_—Å–ø–∏—Å–æ–∫_—é–∑–µ—Ä–æ–≤[assigneeId]?.avatar_url || "{{ url_for('static', filename='images/default_avatar.png') }}";
                // –ü–æ–∫–∞ —á—Ç–æ –±—É–¥–µ–º –ø—Ä–æ—Å—Ç–æ –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å –∏–º–µ–Ω–∞, –∞–≤–∞—Ç–∞—Ä–∫–∏ –æ–±–Ω–æ–≤—è—Ç—Å—è –Ω–∞ —Å–∞–º–æ–π –∫–∞—Ä—Ç–æ—á–∫–µ –ø–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è.
                // –ò–ª–∏, –µ—Å–ª–∏ –º—ã –ø–µ—Ä–µ–¥–∞–µ–º –ø–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ assignees (–≤–∫–ª—é—á–∞—è –∞–≤–∞—Ç–∞—Ä—ã) —á–µ—Ä–µ–∑ data-–∞—Ç—Ä–∏–±—É—Ç –∫–∞—Ä—Ç–æ—á–∫–∏,
                // —Ç–æ –º–æ–∂–Ω–æ –±—É–¥–µ—Ç –∏—Ö –æ—Ç—Ç—É–¥–∞ –±—Ä–∞—Ç—å –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –º–æ–¥–∞–ª–∫–∏.

                const img = document.createElement('img');
                // –ü–æ–ø—ã—Ç–∫–∞ –Ω–∞–π—Ç–∏ –∞–≤–∞—Ç–∞—Ä –∏–∑ data-–∞—Ç—Ä–∏–±—É—Ç–æ–≤ —Å–µ–ª–µ–∫—Ç–∞, –µ—Å–ª–∏ –æ–Ω–∏ —Ç–∞–º –µ—Å—Ç—å (–Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏ populate)
                let avatarUrl = option.dataset.avatarUrl || "{{ url_for('static', filename='images/default_avatar.png') }}";

                img.src = avatarUrl;
                img.alt = assigneeName;
                img.title = assigneeName;
                img.className = 'rounded-circle me-1';
                img.style.width = '30px';
                img.style.height = '30px';
                img.style.objectFit = 'cover';
                modalSelectedAssigneesPreview.appendChild(img);
            });
        }
        if(modalAssigneesSelect) {
            modalAssigneesSelect.addEventListener('change', updateModalAssigneesPreview);
        }


        cardDetailModalEl.addEventListener('show.bs.modal', function (event) {
            var cardElement = event.relatedTarget;
            if (!cardElement || !cardElement.classList.contains('draggable-card')) return;

            var cardId = cardElement.getAttribute('data-card-id');
            var cardTitle = cardElement.getAttribute('data-card-title');
            var cardDescription = cardElement.getAttribute('data-card-description');
            var editUrl = cardElement.getAttribute('data-edit-url');
            var deleteUrl = cardElement.getAttribute('data-delete-url');
            var cardAssigneesJson = cardElement.getAttribute('data-card-assignees');
            var currentAssignees = cardAssigneesJson ? JSON.parse(cardAssigneesJson) : [];
            var currentAssigneeIds = currentAssignees.map(a => a.id.toString()); // ID –∫–∞–∫ —Å—Ç—Ä–æ–∫–∏ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è

            modalForm.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
            modalForm.querySelectorAll('.invalid-feedback').forEach(el => el.textContent = '');

            modalLabel.textContent = '–ö–∞—Ä—Ç–æ—á–∫–∞: ' + cardTitle;
            modalTitleField.value = cardTitle;
            modalDescriptionField.value = cardDescription;
            modalForm.action = editUrl;
            deleteForm.action = deleteUrl;
            
            // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π –≤ SelectMultiple
            Array.from(modalAssigneesSelect.options).forEach(option => {
                option.selected = currentAssigneeIds.includes(option.value);
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º URL –∞–≤–∞—Ç–∞—Ä–∞ –≤ data-–∞—Ç—Ä–∏–±—É—Ç option, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
                const assigneeData = currentAssignees.find(a => a.id.toString() === option.value);
                if (assigneeData && assigneeData.avatar_url) {
                    option.dataset.avatarUrl = assigneeData.avatar_url;
                }
            });
            updateModalAssigneesPreview(); // –û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–µ–≤—å—é

            let deleteCsrfInput = deleteForm.querySelector('input[name="csrf_token"]');
             if (deleteCsrfInput && csrfToken) {
                 deleteCsrfInput.value = csrfToken;
             } else if (!csrfToken) {
                 console.error("CSRF Token missing for delete form in modal.");
             }
        });

        saveButton.addEventListener('click', function() {
            modalForm.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
            modalForm.querySelectorAll('.invalid-feedback').forEach(el => el.textContent = '');

            // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ CSRF —Ç–æ–∫–µ–Ω –µ—Å—Ç—å –≤ —Å–∞–º–æ–π —Ñ–æ—Ä–º–µ
            let formCsrf = modalForm.querySelector('input[name="csrf_token"]');
            if (!formCsrf || !formCsrf.value) {
                 if(csrfToken){ // –ï—Å–ª–∏ –µ—Å—Ç—å –≥–ª–æ–±–∞–ª—å–Ω—ã–π, –Ω–æ –Ω–µ—Ç –≤ —Ñ–æ—Ä–º–µ
                    if(!formCsrf){
                        formCsrf = document.createElement('input');
                        formCsrf.type = 'hidden';
                        formCsrf.name = 'csrf_token';
                        modalForm.appendChild(formCsrf);
                    }
                    formCsrf.value = csrfToken;
                 } else {
                    alert('–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: CSRF —Ç–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
                    return;
                 }
            }

            fetch(modalForm.action, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    // 'X-CSRFToken': csrfToken, // –ù–µ –≤—Å–µ–≥–¥–∞ –Ω—É–∂–µ–Ω —Å FormData, –µ—Å–ª–∏ –µ—Å—Ç—å –≤ —Ç–µ–ª–µ
                },
                body: new FormData(modalForm)
            })
            .then(response => response.json().then(data => ({ status: response.status, body: data })))
            .then(({ status, body }) => {
                if (status === 200 && body.success) {
                    cardModal.hide();
                    updateCardDisplay(body.card);
                } else if (status === 400 && !body.success && body.errors) {
                    displayModalErrors(body.errors);
                } else {
                    alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + (body.error || body.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞.'));
                }
            })
            .catch(error => {
                console.error('Error saving card via modal:', error);
                alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ —Å–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∫–∞—Ä—Ç–æ—á–∫–∏.');
            });
        });

        function displayModalErrors(errors) {
            for (const field in errors) {
                const inputElement = modalForm.querySelector(`[name="${field}"], #${field}`); // –ò—â–µ–º –ø–æ name –∏–ª–∏ id
                const errorElementId = `modal${field.charAt(0).toUpperCase() + field.slice(1)}Error`; // e.g. modalTitleError
                const errorElement = document.getElementById(errorElementId);
                
                if (inputElement) {
                    inputElement.classList.add('is-invalid');
                     // –î–ª—è select multiple –æ—à–∏–±–∫–∏ –º–æ–≥—É—Ç –æ—Ç–Ω–æ—Å–∏—Ç—å—Å—è –∫ —Å–∞–º–æ–º—É –ø–æ–ª—é, –∞ –Ω–µ –∫ feedback —ç–ª–µ–º–µ–Ω—Ç—É –ø–æ–¥ –Ω–∏–º
                    if (inputElement.tagName === 'SELECT' && inputElement.multiple) {
                        let feedback = inputElement.nextElementSibling;
                        if (feedback && feedback.classList.contains('invalid-feedback')) {
                            feedback.textContent = errors[field];
                        } else { // –ï—Å–ª–∏ –Ω–µ—Ç –ø—Ä—è–º–æ–≥–æ invalid-feedback, –¥–æ–±–∞–≤–ª—è–µ–º –∏–ª–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤ –æ–±—â–µ–º
                             if (!errorElement) console.warn(`No specific error display element found for field: ${field} (id: ${errorElementId})`);
                        }
                    }
                }
                 if (errorElement) {
                     errorElement.textContent = errors[field];
                 } else {
                     console.warn(`No specific error display element found for field: ${field} (id: ${errorElementId})`);
                     // –ú–æ–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å –æ–±—â—É—é –æ—à–∏–±–∫—É –≥–¥–µ-—Ç–æ –≤ –º–æ–¥–∞–ª–∫–µ
                     // modalForm.insertAdjacentHTML('afterbegin', `<div class="alert alert-danger">${errors[field]}</div>`);
                 }
            }
        }

        function updateCardDisplay(cardData) {
            const cardElement = document.getElementById(`card-${cardData.id}`);
            if (!cardElement) return;

            cardElement.setAttribute('data-card-title', cardData.title);
            cardElement.setAttribute('data-card-description', cardData.description || '');
            cardElement.setAttribute('data-card-assignees', JSON.stringify(cardData.assignees || []));


            const titleDisplay = cardElement.querySelector('.card-title-display');
            if (titleDisplay) titleDisplay.textContent = cardData.title;

            const descriptionIndicator = cardElement.querySelector('.card-description-indicator');
            const detailsContainer = cardElement.querySelector('.card-details-display');

            if (cardData.description) {
                if (descriptionIndicator) descriptionIndicator.style.display = 'inline';
                else if(detailsContainer) { // –î–æ–±–∞–≤–∏—Ç—å –µ—Å–ª–∏ –Ω–µ –±—ã–ª–æ
                    const newIndicator = document.createElement('small');
                    newIndicator.className = 'text-muted card-description-indicator me-2';
                    newIndicator.title = '–ï—Å—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ';
                    newIndicator.innerHTML = 'üìÑ';
                    detailsContainer.prepend(newIndicator); // –í –Ω–∞—á–∞–ª–æ –¥–µ—Ç–∞–ª–µ–π
                }
            } else {
                 if (descriptionIndicator) descriptionIndicator.style.display = 'none';
            }

            const assigneesListDiv = cardElement.querySelector('.card-assignees-list');
            if (assigneesListDiv) {
                assigneesListDiv.innerHTML = ''; // –û—á–∏—Å—Ç–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –∞–≤–∞—Ç–∞—Ä–∫–∏
                if (cardData.assignees && cardData.assignees.length > 0) {
                    cardData.assignees.forEach(assignee => {
                        const img = document.createElement('img');
                        img.src = assignee.avatar_url;
                        img.alt = assignee.username;
                        img.title = assignee.username;
                        img.className = 'rounded-circle card-assignee-avatar';
                        img.style.width = '24px';
                        img.style.height = '24px';
                        img.style.objectFit = 'cover';
                        img.style.marginRight = '-8px';
                        img.style.border = '1px solid white';
                        assigneesListDiv.appendChild(img);
                    });
                } else {
                    const noAssigneePlaceholder = document.createElement('small');
                    noAssigneePlaceholder.className = 'text-muted fst-italic no-assignee-placeholder';
                    noAssigneePlaceholder.textContent = '–ù–µ—Ç –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π';
                    assigneesListDiv.appendChild(noAssigneePlaceholder);
                }
            }
        }

        // AJAX –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è (–µ—Å–ª–∏ —Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å, —Ñ–æ—Ä–º–∞ –¥–æ–ª–∂–Ω–∞ –∏–º–µ—Ç—å id="deleteCardFormModal")
        deleteForm.addEventListener('submit', function(event) {
             event.preventDefault();
             // confirm —É–∂–µ –µ—Å—Ç—å –≤ HTML button onclick, –Ω–æ –º–æ–∂–Ω–æ –∏ –∑–¥–µ—Å—å
             // if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –∫–∞—Ä—Ç–æ—á–∫—É?')) return;

             let deleteCsrfToken = deleteForm.querySelector('input[name="csrf_token"]').value;
             if (!deleteCsrfToken && csrfToken) deleteCsrfToken = csrfToken; // –§–æ–ª–ª–±—ç–∫ –Ω–∞ –≥–ª–æ–±–∞–ª—å–Ω—ã–π

             if (!deleteCsrfToken) {
                 alert('–û—à–∏–±–∫–∞: CSRF —Ç–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
                 return;
             }

             fetch(deleteForm.action, {
                 method: 'POST',
                 headers: {
                     'X-Requested-With': 'XMLHttpRequest',
                     'X-CSRFToken': deleteCsrfToken // –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–æ–∫–µ–Ω–∞ –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ
                 },
                 // FormData –Ω–µ –Ω—É–∂–µ–Ω –¥–ª—è –ø—Ä–æ—Å—Ç–æ–≥–æ POST, –Ω–æ –∏ –Ω–µ –º–µ—à–∞–µ—Ç –µ—Å–ª–∏ –ø—É—Å—Ç–æ–π
                 // body: new FormData(deleteForm) // –µ—Å–ª–∏ –±—ã –±—ã–ª–∏ –µ—â–µ –ø–æ–ª—è
             })
             .then(response => response.json().then(data => ({ status: response.status, body: data })))
             .then(({ status, body }) => {
                  if (status === 200 && body.success) {
                      cardModal.hide();
                      const cardIdToDelete = deleteForm.action.split('/').filter(Boolean).pop(); // –ü–æ–ª—É—á–∞–µ–º ID –∏–∑ action URL
                      const cardElementToDelete = document.getElementById(`card-${cardIdToDelete}`);
                      if(cardElementToDelete) {
                          const columnList = cardElementToDelete.closest('.card-list');
                          cardElementToDelete.remove();
                          updateNoCardsPlaceholder(columnList);
                      }
                      // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å flash-—Å–æ–æ–±—â–µ–Ω–∏–µ, —Å–æ–∑–¥–∞–≤ –µ–≥–æ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏
                      // createFlashMessage(body.message || '–ö–∞—Ä—Ç–æ—á–∫–∞ —É–¥–∞–ª–µ–Ω–∞.', 'success');
                      console.log(body.message || '–ö–∞—Ä—Ç–æ—á–∫–∞ —É–¥–∞–ª–µ–Ω–∞.'); // –í—Ä–µ–º–µ–Ω–Ω—ã–π –ª–æ–≥
                  } else {
                      alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + (body.error || body.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞.'));
                  }
             })
             .catch(error => {
                 console.error('Error deleting card via modal AJAX:', error);
                 alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ —Å–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∫–∞—Ä—Ç–æ—á–∫–∏.');
             });
         });


    } // end if(cardDetailModalEl)

    // --- Drag-and-Drop ---
    const cardLists = document.querySelectorAll('.card-list');
    const csrfTokenForDrag = csrfToken; 

    cardLists.forEach(list => {
        Sortable.create(list, {
            group: 'cards',
            animation: 150,
            ghostClass: 'sortable-ghost',
            chosenClass: 'sortable-chosen',
            dragClass: 'sortable-drag',
            draggable: '.draggable-card',
            onEnd: function (evt) {
                const itemEl = evt.item;
                const toList = evt.to;
                const fromList = evt.from;
                const oldIndex = evt.oldDraggableIndex;

                const cardId = itemEl.getAttribute('data-card-id');
                const newColumnId = toList.getAttribute('data-column-id');

                updateNoCardsPlaceholder(toList);
                updateNoCardsPlaceholder(fromList);

                const payload = {
                    new_column_id: newColumnId
                };

                if (!csrfTokenForDrag) {
                    console.error('CSRF token not found for drag-and-drop operation.');
                    alert('–û—à–∏–±–∫–∞: CSRF —Ç–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
                    fromList.insertBefore(itemEl, fromList.children[oldIndex]);
                    updateNoCardsPlaceholder(toList);
                    updateNoCardsPlaceholder(fromList);
                    return;
                }

                fetch(`/api/cards/${cardId}/move`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfTokenForDrag
                    },
                    body: JSON.stringify(payload)
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(errData => {
                            throw new Error(errData.error || `Request failed with status ${response.status}`);
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    if (!data.success) {
                        console.error('Failed to move card (API):', data.error || data.message);
                        fromList.insertBefore(itemEl, fromList.children[oldIndex]);
                        updateNoCardsPlaceholder(toList);
                        updateNoCardsPlaceholder(fromList);
                        alert('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è –∫–∞—Ä—Ç–æ—á–∫–∏: ' + (data.error || data.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                    }
                })
                .catch(error => {
                    console.error('Error during fetch for card move:', error);
                    fromList.insertBefore(itemEl, fromList.children[oldIndex]);
                    updateNoCardsPlaceholder(toList);
                    updateNoCardsPlaceholder(fromList);
                    alert('–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–∏ –∫–∞—Ä—Ç–æ—á–∫–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É. (' + error.message + ')');
                });
            }
        });
    });

    function updateNoCardsPlaceholder(listElement) {
        if (!listElement) return;
        let placeholder = listElement.querySelector('.no-cards-placeholder');
        const cardsInList = listElement.querySelectorAll('.draggable-card').length;

        if (cardsInList === 0) {
            if (!placeholder) {
                placeholder = document.createElement('div');
                placeholder.className = 'list-group-item text-muted small fst-italic no-cards-placeholder';
                placeholder.textContent = '–ù–µ—Ç –∫–∞—Ä—Ç–æ—á–µ–∫';
                listElement.appendChild(placeholder);
            }
            placeholder.style.display = 'block';
        } else {
            if (placeholder) {
                placeholder.style.display = 'none';
            }
        }
    }

    cardLists.forEach(list => {
        updateNoCardsPlaceholder(list);
    });

    // –ê–∫—Ç–∏–≤–∞—Ü–∏—è Bootstrap tooltips –¥–ª—è –∞–≤–∞—Ç–∞—Ä–æ–∫ (–µ—Å–ª–∏ –±—É–¥–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å)
    // var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    // var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
    //   return new bootstrap.Tooltip(tooltipTriggerEl);
    // });
});
</script>
{% endblock %}