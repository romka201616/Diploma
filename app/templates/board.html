{% extends "base.html" %}
{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h1>{{ board.name }}</h1>
    <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">–ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É –¥–æ—Å–æ–∫</a>
</div>

<div class="container-fluid">
    <div class="row flex-nowrap overflow-auto pb-3" id="boardColumnsContainer">
        {% for column in columns %}
        <div class="col-md-4 col-lg-3 column-drag-container">
            <div class="card bg-light mb-3 h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 me-2">{{ column.name }}</h5>
                    <div class="d-flex align-items-center">
                         <a href="{{ url_for('edit_column', column_id=column.id) }}" class="btn btn-sm btn-outline-secondary border-0 p-1 me-1" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ–ª–æ–Ω–∫—É">‚úèÔ∏è</a>
                         <form action="{{ url_for('delete_column', column_id=column.id) }}" method="post" onsubmit="return confirm('–£–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∫–æ–ª–æ–Ω–∫—É \'{{ column.name }}\'? –í—Å–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –≤ –Ω–µ–π –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã!');" class="d-inline">
                            <button type="submit" class="btn btn-sm btn-outline-danger border-0 p-1" title="–£–¥–∞–ª–∏—Ç—å –∫–æ–ª–æ–Ω–∫—É">‚úñ</button>
                        </form>
                    </div>
                </div>
                <div class="card-body d-flex flex-column">
                    <div class="list-group list-group-flush mb-3 flex-grow-1 card-list" id="column-{{ column.id }}" data-column-id="{{ column.id }}">
                        {% for card in column.cards.all() %}
                        <div class="list-group-item list-group-item-action card-item-clickable py-2 px-3 draggable-card"
                             data-bs-toggle="modal"
                             data-bs-target="#cardDetailModal"
                             data-card-id="{{ card.id }}"
                             data-card-title="{{ card.title }}"
                             data-card-description="{{ card.description or '' }}"
                             data-edit-url="{{ url_for('edit_card', card_id=card.id) }}"
                             data-delete-url="{{ url_for('delete_card', card_id=card.id) }}">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">{{ card.title }}</h6>
                            </div>
                            {% if card.description %}
                                <small class="text-muted">–ï—Å—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ üìÑ</small>
                            {% endif %}
                        </div>
                        {% else %}
                            <div class="list-group-item text-muted small fst-italic no-cards-placeholder">–ù–µ—Ç –∫–∞—Ä—Ç–æ—á–µ–∫</div>
                        {% endfor %}
                    </div>
                    <form action="{{ url_for('create_card', column_id=column.id) }}" method="post" novalidate class="mt-auto">
                        {{ card_form.hidden_tag() }}
                        <div class="input-group input-group-sm mb-2">
                            {{ card_form.title(class="form-control", placeholder="–ù–æ–≤–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞...", aria_label="–ó–∞–≥–æ–ª–æ–≤–æ–∫ –∫–∞—Ä—Ç–æ—á–∫–∏") }}
                        </div>
                        {{ card_form.submit_card(class="btn btn-outline-primary w-100", value="–î–æ–±–∞–≤–∏—Ç—å") }}
                    </form>
                </div>
            </div>
        </div>
        {% endfor %}

        <div class="col-md-4 col-lg-3">
            <div class="card bg-light">
                <div class="card-body">
                    <form action="{{ url_for('view_board', board_id=board.id) }}" method="post" novalidate>
                        {{ column_form.hidden_tag() }}
                         <div class="mb-2">
                            {{ column_form.name.label(class="form-label visually-hidden") }}
                            {{ column_form.name(class="form-control form-control-sm" + (" is-invalid" if column_form.errors.name else ""), placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–π –∫–æ–ª–æ–Ω–∫–∏") }}
                            {% if column_form.name.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in column_form.name.errors %}<span>{{ error }}</span><br>{% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        {{ column_form.submit_column(class="btn btn-primary btn-sm w-100", value="–î–æ–±–∞–≤–∏—Ç—å –∫–æ–ª–æ–Ω–∫—É") }}
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–µ—Ç–∞–ª–µ–π/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–∞—Ä—Ç–æ—á–∫–∏ -->
<div class="modal fade" id="cardDetailModal" tabindex="-1" aria-labelledby="cardDetailModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="cardDetailModalLabel">–î–µ—Ç–∞–ª–∏ –∫–∞—Ä—Ç–æ—á–∫–∏</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="editCardFormModal" method="post" action="">
            {{ card_form.hidden_tag() }} {# CSRF token from the main card_form instance #}
            <div class="mb-3">
                <label for="modalCardTitle" class="form-label">–ó–∞–≥–æ–ª–æ–≤–æ–∫ –∫–∞—Ä—Ç–æ—á–∫–∏</label>
                <input type="text" class="form-control" id="modalCardTitle" name="title" required maxlength="150">
            </div>
            <div class="mb-3">
                <label for="modalCardDescription" class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                <textarea class="form-control" id="modalCardDescription" name="description" rows="5" maxlength="1000"></textarea>
            </div>
            <input type="submit" name="submit_card" style="display:none;"> {# For compatibility with CardForm submit button name #}
        </form>
      </div>
      <div class="modal-footer justify-content-between">
        <div>
            <form id="deleteCardFormModal" method="post" action="" class="d-inline" onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É?');">
                 {# CSRF token should be part of the form if Flask-WTF protects POST to delete_card without a form object #}
                 {# For now, relying on editCardFormModal's CSRF or main page's implicit one if it covers this POST too #}
                 <button type="submit" class="btn btn-danger">–£–¥–∞–ª–∏—Ç—å</button>
            </form>
        </div>
        <div>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
            <button type="submit" class="btn btn-primary" form="editCardFormModal">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }} {# For Bootstrap JS from base.html #}
<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js" integrity="sha512-Eezs+g9Lq4TCCq0wae01s9PuNWzHYoCMkE97e2qdkYthpI0pzC3UGB03lgEHn2XM85hDOUF6qgqqszs+iXU4UA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    var cardDetailModalEl = document.getElementById('cardDetailModal');
    if (cardDetailModalEl) {
        var modalForm = document.getElementById('editCardFormModal');
        var modalTitleField = document.getElementById('modalCardTitle');
        var modalDescriptionField = document.getElementById('modalCardDescription');
        var modalLabel = document.getElementById('cardDetailModalLabel');
        var deleteForm = document.getElementById('deleteCardFormModal');
        var csrfToken = modalForm.querySelector('input[name="csrf_token"]').value;


        cardDetailModalEl.addEventListener('show.bs.modal', function (event) {
            var cardElement = event.relatedTarget;
            if (!cardElement || !cardElement.classList.contains('draggable-card')) return;

            var cardId = cardElement.getAttribute('data-card-id');
            var cardTitle = cardElement.getAttribute('data-card-title');
            var cardDescription = cardElement.getAttribute('data-card-description');
            var editUrl = cardElement.getAttribute('data-edit-url');
            var deleteUrl = cardElement.getAttribute('data-delete-url');

            modalLabel.textContent = '–ö–∞—Ä—Ç–æ—á–∫–∞: ' + cardTitle;
            modalTitleField.value = cardTitle;
            modalDescriptionField.value = cardDescription;
            modalForm.action = editUrl;
            deleteForm.action = deleteUrl;
            
            // Ensure CSRF token is in the delete form if it's separate and POSTing
            let deleteCsrfInput = deleteForm.querySelector('input[name="csrf_token"]');
            if (!deleteCsrfInput) {
                deleteCsrfInput = document.createElement('input');
                deleteCsrfInput.type = 'hidden';
                deleteCsrfInput.name = 'csrf_token';
                deleteForm.appendChild(deleteCsrfInput);
            }
            deleteCsrfInput.value = csrfToken;
        });
    }

    const cardLists = document.querySelectorAll('.card-list');
    const csrfTokenForDrag = document.querySelector('#editCardFormModal input[name="csrf_token"]')?.value || // try to get from modal
                             document.querySelector('form input[name="csrf_token"]')?.value; // fallback to any form on page

    cardLists.forEach(list => {
        Sortable.create(list, {
            group: 'cards',
            animation: 150,
            ghostClass: 'sortable-ghost',
            draggable: '.draggable-card',
            onEnd: function (evt) {
                const itemEl = evt.item;
                const toList = evt.to;
                const fromList = evt.from;

                const cardId = itemEl.getAttribute('data-card-id');
                const newColumnId = toList.getAttribute('data-column-id');

                updateNoCardsPlaceholder(toList);
                updateNoCardsPlaceholder(fromList);

                const payload = {
                    new_column_id: newColumnId
                };

                fetch(`/api/cards/${cardId}/move`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfTokenForDrag // –ü–µ—Ä–µ–¥–∞–µ–º CSRF-—Ç–æ–∫–µ–Ω
                    },
                    body: JSON.stringify(payload)
                })
                .then(response => {
                    if (!response.ok) {
                        // –ï—Å–ª–∏ —Å—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞ –Ω–µ 2xx, –ø—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—Å—Ç –æ—à–∏–±–∫–∏
                        return response.json().then(errData => {
                            throw new Error(errData.error || `Request failed with status ${response.status}`);
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        // console.log('Card moved successfully via API');
                    } else {
                        console.error('Failed to move card (API):', data.error);
                        // –í–µ—Ä–Ω—É—Ç—å —ç–ª–µ–º–µ–Ω—Ç –æ–±—Ä–∞—Ç–Ω–æ –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ —Å–µ—Ä–≤–µ—Ä–∞
                        fromList.insertBefore(itemEl, fromList.children[evt.oldDraggableIndex]);
                        updateNoCardsPlaceholder(toList); // –û–±–Ω–æ–≤–∏—Ç—å –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä—ã –æ–±—Ä–∞—Ç–Ω–æ
                        updateNoCardsPlaceholder(fromList);
                        alert('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è –∫–∞—Ä—Ç–æ—á–∫–∏: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                    }
                })
                .catch(error => {
                    console.error('Error during fetch for card move:', error);
                    // –í–µ—Ä–Ω—É—Ç—å —ç–ª–µ–º–µ–Ω—Ç –æ–±—Ä–∞—Ç–Ω–æ –≤ —Å–ª—É—á–∞–µ —Å–µ—Ç–µ–≤–æ–π –æ—à–∏–±–∫–∏ –∏–ª–∏ –¥—Ä—É–≥–æ–π –æ—à–∏–±–∫–∏ JS
                    fromList.insertBefore(itemEl, fromList.children[evt.oldDraggableIndex]);
                    updateNoCardsPlaceholder(toList);
                    updateNoCardsPlaceholder(fromList);
                    alert('–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–∏ –∫–∞—Ä—Ç–æ—á–∫–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É. (' + error.message + ')');
                });
            }
        });
    });

    function updateNoCardsPlaceholder(listElement) {
        if (!listElement) return;
        let placeholder = listElement.querySelector('.no-cards-placeholder');
        const cardsInList = listElement.querySelectorAll('.draggable-card').length;

        if (cardsInList === 0) {
            if (!placeholder) {
                placeholder = document.createElement('div');
                placeholder.className = 'list-group-item text-muted small fst-italic no-cards-placeholder';
                placeholder.textContent = '–ù–µ—Ç –∫–∞—Ä—Ç–æ—á–µ–∫';
                listElement.appendChild(placeholder);
            }
            placeholder.style.display = 'block';
        } else {
            if (placeholder) {
                placeholder.style.display = 'none';
            }
        }
    }
    
    cardLists.forEach(list => {
        updateNoCardsPlaceholder(list);
    });

});
</script>
{% endblock %}