
{% extends "base.html" %}
{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h1>{{ board.name }} <small class="text-muted fs-6">(–í–ª–∞–¥–µ–ª–µ—Ü: {{ board.owner.username }})</small></h1>
    <div> {# –û–±–µ—Ä—Ç–∫–∞ –¥–ª—è –∫–Ω–æ–ø–æ–∫ —Å–ø—Ä–∞–≤–∞ #}
        {% if current_user.can_delete_board(board) %} {# –¢–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª–µ—Ü –≤–∏–¥–∏—Ç –∫–Ω–æ–ø–∫—É –Ω–∞—Å—Ç—Ä–æ–µ–∫ –¥–æ—Å–∫–∏ #}
        <a href="{{ url_for('edit_board', board_id=board.id) }}" class="btn btn-outline-secondary me-2">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–æ—Å–∫–∏</a>
        {% endif %}
        <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">–ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É –¥–æ—Å–æ–∫</a>
    </div>
</div>

<!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–∞–º–∏ (—Ç–æ–ª—å–∫–æ –¥–ª—è –≤–ª–∞–¥–µ–ª—å—Ü–∞) -->
{% if is_owner %}
<div class="card mb-4">
    <div class="card-header">
        –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–∞–º–∏
    </div>
    <div class="card-body">
        <h5>–ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h5>
        <form action="{{ url_for('invite_to_board', board_id=board.id) }}" method="post" novalidate class="row g-3 align-items-end">
            {{ invite_form.hidden_tag() }}
            <div class="col-md-6">
                {{ invite_form.email_or_username.label(class="form-label") }}
                {{ invite_form.email_or_username(class="form-control form-control-sm" + (" is-invalid" if invite_form.email_or_username.errors else "")) }}
                {% if invite_form.email_or_username.errors %}
                    <div class="invalid-feedback d-block">
                        {% for error in invite_form.email_or_username.errors %}<span>{{ error }}</span><br>{% endfor %}
                    </div>
                {% endif %}
            </div>
            <div class="col-auto">
                {{ invite_form.submit_invite(class="btn btn-sm btn-success") }}
            </div>
        </form>
        <hr>
        <h5>–¢–µ–∫—É—â–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏ –∏ –≤–ª–∞–¥–µ–ª–µ—Ü:</h5>
         <ul class="list-group list-group-flush">
            {# –í—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤–ª–∞–¥–µ–ª—å—Ü–∞ #}
             <li class="list-group-item d-flex justify-content-between align-items-center">
                {{ board.owner.username }} ({{ board.owner.email }})
                <span class="badge bg-primary">–í–ª–∞–¥–µ–ª–µ—Ü</span>
             </li>
             {# –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ #}
            {% set owner_id = board.owner.id %}
            {% for member in board_members %}
                {% if member.id != owner_id %} {# –ù–µ –¥—É–±–ª–∏—Ä—É–µ–º –≤–ª–∞–¥–µ–ª—å—Ü–∞, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å –≤ members #}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    {{ member.username }} ({{ member.email }})
                    <form action="{{ url_for('remove_from_board', board_id=board.id, user_id=member.id) }}" method="post" onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å {{ member.username }} —Å —ç—Ç–æ–π –¥–æ—Å–∫–∏?');" class="d-inline">
                         <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"> {# –î–æ–±–∞–≤–ª–µ–Ω CSRF —Ç–æ–∫–µ–Ω –¥–ª—è —Ñ–æ—Ä–º—ã —É–¥–∞–ª–µ–Ω–∏—è —É—á–∞—Å—Ç–Ω–∏–∫–∞ #}
                        <button type="submit" class="btn btn-sm btn-outline-warning">–£–¥–∞–ª–∏—Ç—å</button>
                    </form>
                </li>
                {% endif %}
            {% endfor %}
            {% if not board_members or (board_members|length == 1 and board_members[0].id == owner_id) %}
                 <li class="list-group-item text-muted">–î—Ä—É–≥–∏—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –Ω–µ—Ç.</li>
            {% endif %}
        </ul>
    </div>
</div>
{% elif board_members or board.owner %} {# –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –¥–ª—è –Ω–µ-–≤–ª–∞–¥–µ–ª—å—Ü–µ–≤ #}
    <div class="card mb-4">
        <div class="card-header">
            –£—á–∞—Å—Ç–Ω–∏–∫–∏ –¥–æ—Å–∫–∏
        </div>
         <div class="card-body">
            <ul class="list-group list-group-flush">
                 <li class="list-group-item d-flex justify-content-between align-items-center">
                    {{ board.owner.username }}
                    <span class="badge bg-primary">–í–ª–∞–¥–µ–ª–µ—Ü</span>
                 </li>
                 {% set owner_id = board.owner.id %}
                 {% for member in board_members %}
                      {% if member.id != owner_id %}
                      <li class="list-group-item d-flex justify-content-between align-items-center">
                          {{ member.username }}
                          {% if member == current_user %}
                              <form action="{{ url_for('remove_from_board', board_id=board.id, user_id=member.id) }}" method="post" onsubmit="return confirm('–ü–æ–∫–∏–Ω—É—Ç—å –¥–æ—Å–∫—É {{ board.name }}?');" class="d-inline">
                                   <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"> {# CSRF –¥–ª—è —Ñ–æ—Ä–º—ã –≤—ã—Ö–æ–¥–∞ #}
                                  <button type="submit" class="btn btn-sm btn-outline-warning">–ü–æ–∫–∏–Ω—É—Ç—å –¥–æ—Å–∫—É</button>
                              </form>
                          {% else %}
                             <span class="badge bg-secondary">–£—á–∞—Å—Ç–Ω–∏–∫</span>
                          {% endif %}
                      </li>
                      {% endif %}
                 {% endfor %}
            </ul>
        </div>
    </div>
{% endif %}


<div class="container-fluid px-0">
    <div class="row flex-nowrap overflow-auto pb-3" id="boardColumnsContainer">
        {% for column in columns %}
        <div class="col-md-4 col-lg-3 column-drag-container">
            <div class="card bg-light mb-3 h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 me-2">{{ column.name }}</h5>
                    {% if current_user.can_edit_board(board) %}
                    <div class="d-flex align-items-center">
                         <a href="{{ url_for('edit_column', column_id=column.id) }}" class="btn btn-sm btn-outline-secondary border-0 p-1 me-1" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ–ª–æ–Ω–∫—É">‚úèÔ∏è</a>
                         <form action="{{ url_for('delete_column', column_id=column.id) }}" method="post" onsubmit="return confirm('–£–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∫–æ–ª–æ–Ω–∫—É \'{{ column.name }}\'? –í—Å–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –≤ –Ω–µ–π –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã!');" class="d-inline">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"> {# CSRF —Ç–æ–∫–µ–Ω –¥–ª—è —Ñ–æ—Ä–º—ã —É–¥–∞–ª–µ–Ω–∏—è –∫–æ–ª–æ–Ω–∫–∏ #}
                            <button type="submit" class="btn btn-sm btn-outline-danger border-0 p-1" title="–£–¥–∞–ª–∏—Ç—å –∫–æ–ª–æ–Ω–∫—É">‚úñ</button>
                        </form>
                    </div>
                    {% endif %}
                </div>
                <div class="card-body d-flex flex-column">
                    <div class="list-group list-group-flush mb-3 flex-grow-1 card-list" id="column-{{ column.id }}" data-column-id="{{ column.id }}">
                        {% for card in column.cards.all() %}
                        <div class="list-group-item list-group-item-action card-item-clickable py-2 px-3 draggable-card"
                             data-bs-toggle="modal"
                             data-bs-target="#cardDetailModal"
                             data-card-id="{{ card.id }}"
                             data-card-title="{{ card.title }}"
                             data-card-description="{{ card.description or '' }}"
                             data-edit-url="{{ url_for('edit_card', card_id=card.id) }}"
                             data-delete-url="{{ url_for('delete_card', card_id=card.id) }}"
                             data-card-assignee-id="{{ card.assignee_id or 0 }}" {# ID –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è (–∏–ª–∏ 0) #}
                             id="card-{{ card.id }}"> {# –î–∞–µ–º ID —Å–∞–º–æ–π –∫–∞—Ä—Ç–æ—á–∫–µ –¥–ª—è –ª–µ–≥–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è #}
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1 card-title-display">{{ card.title }}</h6>
                                {# –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∏–∫–æ–Ω–∫—É —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä—è–º–æ —Ç—É—Ç, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ #}
                            </div>
                            <div class="card-details-display"> {# –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –¥–æ–ø. –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ #}
                                {% if card.description %}
                                    <small class="text-muted card-description-indicator">–ï—Å—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ üìÑ</small>
                                {% endif %}
                                {% if card.assignee %}
                                    <small class="text-info d-block mt-1 card-assignee-display">–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å: @{{ card.assignee.username }}</small>
                                {% else %}
                                     <small class="text-muted d-block mt-1 card-assignee-display fst-italic">–ù–µ—Ç –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è</small>
                                {% endif %}
                            </div>
                        </div>
                        {% else %}
                            <div class="list-group-item text-muted small fst-italic no-cards-placeholder">–ù–µ—Ç –∫–∞—Ä—Ç–æ—á–µ–∫</div>
                        {% endfor %}
                    </div>
                    {% if current_user.can_edit_board(board) %}
                     {# –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–π –∫–∞—Ä—Ç–æ—á–∫–∏ –≤ –ö–û–ù–¶–ï –∫–æ–ª–æ–Ω–∫–∏ #}
                    <form action="{{ url_for('create_card', column_id=column.id) }}" method="post" novalidate class="mt-auto add-card-form">
                        {{ card_form.hidden_tag() }} {# CSRF –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–∞—Ä—Ç–æ—á–∫–∏ #}
                        <div class="mb-2">
                             {{ card_form.title.label(class="form-label visually-hidden") }}
                            {{ card_form.title(class="form-control form-control-sm", placeholder="–ù–æ–≤–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞...", aria_label="–ó–∞–≥–æ–ª–æ–≤–æ–∫ –∫–∞—Ä—Ç–æ—á–∫–∏") }}
                             {# –û—à–∏–±–∫–∏ –¥–ª—è title, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ, –º–æ–∂–Ω–æ –≤—ã–≤–µ—Å—Ç–∏ #}
                        </div>
                         {# –°–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ –æ–ø–∏—Å–∞–Ω–∏—è, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–ª—è—Ç—å —Å—Ä–∞–∑—É #}
                         {{ card_form.description(style="display:none;") }}

                         {# –í—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –≤ —Ñ–æ—Ä–º–µ –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è) #}
                         {# –ï—Å–ª–∏ –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–ª—è—Ç—å –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è —Å—Ä–∞–∑—É: #}
                         {# <div class="mb-2"> #}
                         {#    {{ card_form.assignee_id.label(class="form-label visually-hidden") }} #}
                         {#    {{ card_form.assignee_id(class="form-select form-select-sm") }} #}
                         {# </div> #}
                         {# –í —Ñ–æ—Ä–º–µ –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –æ—Å—Ç–∞–≤–∏–º —Ç–æ–ª—å–∫–æ –∑–∞–≥–æ–ª–æ–≤–æ–∫ #}
                         {{ card_form.assignee_id(style="display:none;", value="0") }} {# –°–∫—Ä—ã—Ç–æ, –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é '–Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω' #}

                        {{ card_form.submit_card(class="btn btn-sm btn-outline-primary w-100", value="+ –î–æ–±–∞–≤–∏—Ç—å") }}
                         {# –í—ã–≤–æ–¥ –æ—à–∏–±–æ–∫ —Ñ–æ—Ä–º—ã –¥–æ–±–∞–≤–ª–µ–Ω–∏—è, –µ—Å–ª–∏ –æ–Ω–∏ –±—ã–ª–∏ #}
                         {% if card_form.errors and request.form.get('column_id') == column.id|string %} {# –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫–∏ —Ç–æ–ª—å–∫–æ –¥–ª—è –Ω—É–∂–Ω–æ–π –∫–æ–ª–æ–Ω–∫–∏ #}
                              <div class="mt-2 text-danger small">
                                  {% for field, error_list in card_form.errors.items() %}
                                      {% if field != 'csrf_token' %}
                                         {% for error in error_list %}{{error}}<br>{% endfor %}
                                      {% endif %}
                                  {% endfor %}
                              </div>
                         {% endif %}
                    </form>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}

        {% if current_user.can_edit_board(board) %}
        <div class="col-md-4 col-lg-3">
            <div class="card bg-light">
                <div class="card-body">
                    <form action="{{ url_for('view_board', board_id=board.id) }}" method="post" novalidate>
                        {{ column_form.hidden_tag() }} {# CSRF –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–æ–ª–æ–Ω–∫–∏ #}
                         <div class="mb-2">
                            {{ column_form.name.label(class="form-label visually-hidden") }}
                            {{ column_form.name(class="form-control form-control-sm" + (" is-invalid" if column_form.errors.name else ""), placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–π –∫–æ–ª–æ–Ω–∫–∏") }}
                            {% if column_form.name.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in column_form.name.errors %}<span>{{ error }}</span><br>{% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        {{ column_form.submit_column(class="btn btn-primary btn-sm w-100", value="–î–æ–±–∞–≤–∏—Ç—å –∫–æ–ª–æ–Ω–∫—É") }}
                    </form>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–µ—Ç–∞–ª–µ–π/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–∞—Ä—Ç–æ—á–∫–∏ -->
<div class="modal fade" id="cardDetailModal" tabindex="-1" aria-labelledby="cardDetailModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="cardDetailModalLabel">–î–µ—Ç–∞–ª–∏ –∫–∞—Ä—Ç–æ—á–∫–∏</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        {# –§–æ—Ä–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤–Ω—É—Ç—Ä–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ #}
        {# –ò—Å–ø–æ–ª—å–∑—É–µ–º card_form, –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–π –≤ —à–∞–±–ª–æ–Ω, –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ –ø–æ–ª–µ–π #}
        <form id="editCardFormModal" method="post" action="">
            {{ card_form.hidden_tag() }} {# CSRF token from the main card_form instance #}
            <div class="mb-3">
                {{ card_form.title.label(for="modalCardTitle", class="form-label") }}
                {{ card_form.title(class="form-control", id="modalCardTitle", required=True, maxlength=150) }}
                 <div class="invalid-feedback" id="modalTitleError"></div>
            </div>
            <div class="mb-3">
                 {{ card_form.description.label(for="modalCardDescription", class="form-label") }}
                 {{ card_form.description(class="form-control", id="modalCardDescription", rows=5, maxlength=1000) }}
                 <div class="invalid-feedback" id="modalDescriptionError"></div>
            </div>
            {# --- –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ –≤—ã–±–æ—Ä–∞ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è --- #}
            <div class="mb-3">
                {{ card_form.assignee_id.label(for="modalCardAssignee", class="form-label") }}
                {# –†–µ–Ω–¥–µ—Ä–∏–º select —Å —É–∂–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–º–∏ choices –∏–∑ card_form #}
                {{ card_form.assignee_id(class="form-select", id="modalCardAssignee") }}
                <div class="invalid-feedback" id="modalAssigneeError"></div>
            </div>
            {# --- –ö–æ–Ω–µ—Ü –¥–æ–±–∞–≤–ª–µ–Ω–∏—è --- #}

            {# –°–∫—Ä—ã—Ç–∞—è –∫–Ω–æ–ø–∫–∞ submit, —á—Ç–æ–±—ã –∏–º—è —Å–æ–≤–ø–∞–¥–∞–ª–æ —Å –∏–º–µ–Ω–µ–º –≤ CardForm #}
            <input type="submit" name="submit_card" style="display:none;">
        </form>
      </div>
      <div class="modal-footer justify-content-between">
        <div> {# –õ–µ–≤–∞—è —á–∞—Å—Ç—å —Ñ—É—Ç–µ—Ä–∞ - –£–¥–∞–ª–µ–Ω–∏–µ #}
            <form id="deleteCardFormModal" method="post" action="" class="d-inline" onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –∫–∞—Ä—Ç–æ—á–∫—É?');">
                 {# CSRF —Ç–æ–∫–µ–Ω –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ JS #}
                 <input type="hidden" name="csrf_token" value="">
                 <button type="submit" class="btn btn-danger">–£–¥–∞–ª–∏—Ç—å</button>
            </form>
        </div>
        <div> {# –ü—Ä–∞–≤–∞—è —á–∞—Å—Ç—å —Ñ—É—Ç–µ—Ä–∞ - –ó–∞–∫—Ä—ã—Ç—å –∏ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å #}
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
            {# –ö–Ω–æ–ø–∫–∞ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å" —Ç–µ–ø–µ—Ä—å –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Ñ–æ—Ä–º—É —á–µ—Ä–µ–∑ JS #}
            <button type="button" class="btn btn-primary" id="saveCardModalBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }} {# For Bootstrap JS from base.html #}
<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js" integrity="sha512-Eezs+g9Lq4TCCq0wae01s9PuNWzHYoCMkE97e2qdkYthpI0pzC3UGB03lgEHn2XM85hDOUF6qgqqszs+iXU4UA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    // --- –õ–æ–≥–∏–∫–∞ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ ---
    var cardDetailModalEl = document.getElementById('cardDetailModal');
    var cardModal = bootstrap.Modal.getInstance(cardDetailModalEl) || new bootstrap.Modal(cardDetailModalEl);

    if (cardDetailModalEl) {
        var modalForm = document.getElementById('editCardFormModal');
        var modalTitleField = document.getElementById('modalCardTitle');
        var modalDescriptionField = document.getElementById('modalCardDescription');
        var modalAssigneeSelect = document.getElementById('modalCardAssignee'); // –°–µ–ª–µ–∫—Ç –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è
        var modalLabel = document.getElementById('cardDetailModalLabel');
        var deleteForm = document.getElementById('deleteCardFormModal');
        var saveButton = document.getElementById('saveCardModalBtn');

        // –ü–æ–ª—É—á–∞–µ–º CSRF —Ç–æ–∫–µ–Ω –∏–∑ –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ–æ—Ä–º—ã –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–∞—Ä—Ç–æ—á–∫–∏ (–¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ)
        var csrfTokenInput = document.querySelector('.add-card-form input[name="csrf_token"]');
        var csrfToken = csrfTokenInput ? csrfTokenInput.value : null;
         if (!csrfToken) {
             console.error("CSRF Token not found on the page!");
             // –í–æ–∑–º–æ–∂–Ω–æ, —Å—Ç–æ–∏—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –∏–ª–∏ –ø–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
         }


        cardDetailModalEl.addEventListener('show.bs.modal', function (event) {
            var cardElement = event.relatedTarget;
            if (!cardElement || !cardElement.classList.contains('draggable-card')) return;

            var cardId = cardElement.getAttribute('data-card-id');
            var cardTitle = cardElement.getAttribute('data-card-title');
            var cardDescription = cardElement.getAttribute('data-card-description');
            var editUrl = cardElement.getAttribute('data-edit-url');
            var deleteUrl = cardElement.getAttribute('data-delete-url');
            var cardAssigneeId = cardElement.getAttribute('data-card-assignee-id'); // –ü–æ–ª—É—á–∞–µ–º ID –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è

            // –û—á–∏—Å—Ç–∫–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –æ—à–∏–±–æ–∫ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
            modalForm.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
            modalForm.querySelectorAll('.invalid-feedback').forEach(el => el.textContent = '');

            // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–æ–ª–µ–π –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
            modalLabel.textContent = '–ö–∞—Ä—Ç–æ—á–∫–∞: ' + cardTitle;
            modalTitleField.value = cardTitle;
            modalDescriptionField.value = cardDescription;
            modalAssigneeSelect.value = cardAssigneeId; // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è
            modalForm.action = editUrl;
            deleteForm.action = deleteUrl;

            // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ CSRF —Ç–æ–∫–µ–Ω–∞ –¥–ª—è —Ñ–æ—Ä–º—ã —É–¥–∞–ª–µ–Ω–∏—è
            let deleteCsrfInput = deleteForm.querySelector('input[name="csrf_token"]');
             if (deleteCsrfInput && csrfToken) {
                 deleteCsrfInput.value = csrfToken;
             } else if (!deleteCsrfInput && csrfToken) {
                 // –ï—Å–ª–∏ –∏–Ω–ø—É—Ç–∞ –Ω–µ—Ç, —Å–æ–∑–¥–∞–µ–º (–Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π)
                 deleteCsrfInput = document.createElement('input');
                 deleteCsrfInput.type = 'hidden';
                 deleteCsrfInput.name = 'csrf_token';
                 deleteCsrfInput.value = csrfToken;
                 deleteForm.appendChild(deleteCsrfInput);
             } else if (!csrfToken) {
                 console.error("CSRF Token missing for delete form.");
             }
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è" –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ (AJAX)
        saveButton.addEventListener('click', function() {
            if (!csrfToken) {
                alert('–û—à–∏–±–∫–∞: CSRF —Ç–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
                return;
            }
            // –û—á–∏—Å—Ç–∫–∞ –æ—à–∏–±–æ–∫ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
            modalForm.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
            modalForm.querySelectorAll('.invalid-feedback').forEach(el => el.textContent = '');

            fetch(modalForm.action, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': csrfToken // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–∫–µ–Ω –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ
                },
                body: new FormData(modalForm) // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã
            })
            .then(response => response.json().then(data => ({ status: response.status, body: data })))
            .then(({ status, body }) => {
                if (status === 200 && body.success) {
                    // –£—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ
                    cardModal.hide(); // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                    updateCardDisplay(body.card); // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –Ω–∞ –¥–æ—Å–∫–µ
                    // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å flash-—Å–æ–æ–±—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ JS, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
                } else if (status === 400 && !body.success) {
                    // –û—à–∏–±–∫–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Ñ–æ—Ä–º—ã
                    displayModalErrors(body.errors);
                } else {
                    // –î—Ä—É–≥–∏–µ –æ—à–∏–±–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 403 Forbidden, 500 Server Error)
                    alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + (body.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞.'));
                }
            })
            .catch(error => {
                console.error('Error saving card via modal:', error);
                alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ —Å–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∫–∞—Ä—Ç–æ—á–∫–∏.');
            });
        });

         // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ—à–∏–±–æ–∫ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
        function displayModalErrors(errors) {
            for (const field in errors) {
                const inputElement = modalForm.querySelector(`[name="${field}"]`);
                const errorElement = document.getElementById(`modal${field.charAt(0).toUpperCase() + field.slice(1)}Error`); // e.g., modalTitleError
                if (inputElement) {
                    inputElement.classList.add('is-invalid');
                }
                 if (errorElement) {
                     errorElement.textContent = errors[field];
                 } else { // –û–±—â–∞—è –æ—à–∏–±–∫–∞, –µ—Å–ª–∏ –Ω–µ—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—è
                     console.warn(`No specific error display element found for field: ${field}`);
                     alert(`–û—à–∏–±–∫–∞ –≤ –ø–æ–ª–µ ${field}: ${errors[field]}`);
                 }
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫–∞—Ä—Ç–æ—á–∫–∏ –Ω–∞ –¥–æ—Å–∫–µ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
        function updateCardDisplay(cardData) {
            const cardElement = document.getElementById(`card-${cardData.id}`);
            if (!cardElement) return;

            // –û–±–Ω–æ–≤–ª—è–µ–º data-* –∞—Ç—Ä–∏–±—É—Ç—ã
            cardElement.setAttribute('data-card-title', cardData.title);
            cardElement.setAttribute('data-card-description', cardData.description || '');
            cardElement.setAttribute('data-card-assignee-id', cardData.assignee ? cardData.assignee.id : '0');

            // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–¥–∏–º—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
            const titleDisplay = cardElement.querySelector('.card-title-display');
            if (titleDisplay) titleDisplay.textContent = cardData.title;

            const descriptionIndicator = cardElement.querySelector('.card-description-indicator');
            if (cardData.description) {
                if (!descriptionIndicator) { // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ –±—ã–ª–æ
                     const detailsContainer = cardElement.querySelector('.card-details-display');
                     if (detailsContainer) {
                         const newIndicator = document.createElement('small');
                         newIndicator.className = 'text-muted card-description-indicator';
                         newIndicator.innerHTML = '–ï—Å—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ üìÑ';
                         // –í—Å—Ç–∞–≤–ª—è–µ–º –ø–µ—Ä–µ–¥ —ç–ª–µ–º–µ–Ω—Ç–æ–º –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å, –∏–Ω–∞—á–µ –≤ –∫–æ–Ω–µ—Ü
                         const assigneeDisplay = detailsContainer.querySelector('.card-assignee-display');
                         if(assigneeDisplay) {
                             detailsContainer.insertBefore(newIndicator, assigneeDisplay);
                         } else {
                              detailsContainer.appendChild(newIndicator);
                         }
                     }
                } else {
                    descriptionIndicator.style.display = ''; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º, –µ—Å–ª–∏ –±—ã–ª —Å–∫—Ä—ã—Ç
                }
            } else {
                 if (descriptionIndicator) descriptionIndicator.style.display = 'none'; // –°–∫—Ä—ã–≤–∞–µ–º, –µ—Å–ª–∏ –æ–ø–∏—Å–∞–Ω–∏—è –Ω–µ—Ç
            }

            const assigneeDisplay = cardElement.querySelector('.card-assignee-display');
            if (assigneeDisplay) { // –≠–ª–µ–º–µ–Ω—Ç –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è –¥–æ–ª–∂–µ–Ω —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å
                 if (cardData.assignee) {
                     assigneeDisplay.textContent = `–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å: @${cardData.assignee.username}`;
                     assigneeDisplay.className = 'text-info d-block mt-1 card-assignee-display'; // –°—Ç–∏–ª–∏ –¥–ª—è –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω–æ–≥–æ
                 } else {
                     assigneeDisplay.textContent = '–ù–µ—Ç –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è';
                     assigneeDisplay.className = 'text-muted d-block mt-1 card-assignee-display fst-italic'; // –°—Ç–∏–ª–∏ –¥–ª—è –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω–æ–≥–æ
                 }
            } else {
                 console.warn("Assignee display element not found for card update.");
            }
        }

         // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã —É–¥–∞–ª–µ–Ω–∏—è —á–µ—Ä–µ–∑ AJAX (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
         // –°–µ–π—á–∞—Å –æ–Ω–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ –æ–±—ã—á–Ω–∞—è —Ñ–æ—Ä–º–∞ —Å –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
         // –ï—Å–ª–∏ –Ω—É–∂–Ω–∞ AJAX –æ—Ç–ø—Ä–∞–≤–∫–∞:
         /*
         deleteForm.addEventListener('submit', function(event) {
             event.preventDefault(); // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –æ—Ç–ø—Ä–∞–≤–∫—É
             if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –∫–∞—Ä—Ç–æ—á–∫—É?')) return;
             if (!csrfToken) {
                 alert('–û—à–∏–±–∫–∞: CSRF —Ç–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
                 return;
             }

             fetch(deleteForm.action, {
                 method: 'POST',
                 headers: {
                     'X-Requested-With': 'XMLHttpRequest',
                     'X-CSRFToken': csrfToken
                 }
                 // –¢–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞ –Ω–µ –Ω—É–∂–Ω–æ –¥–ª—è –ø—Ä–æ—Å—Ç–æ–≥–æ POST —É–¥–∞–ª–µ–Ω–∏—è
             })
             .then(response => response.json().then(data => ({ status: response.status, body: data })))
             .then(({ status, body }) => {
                  if (status === 200 && body.success) {
                      cardModal.hide();
                      const cardElement = document.getElementById(`card-${deleteForm.action.split('/').pop()}`); // –ü–æ–ª—É—á–∞–µ–º ID –∏–∑ action URL
                      if(cardElement) {
                          const columnList = cardElement.closest('.card-list');
                          cardElement.remove();
                          updateNoCardsPlaceholder(columnList); // –û–±–Ω–æ–≤–ª—è–µ–º –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä –≤ –∫–æ–ª–æ–Ω–∫–µ
                      }
                      // –ü–æ–∫–∞–∑–∞—Ç—å flash —Å–æ–æ–±—â–µ–Ω–∏–µ?
                      alert(body.message || '–ö–∞—Ä—Ç–æ—á–∫–∞ —É–¥–∞–ª–µ–Ω–∞.');
                  } else {
                      alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + (body.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞.'));
                  }
             })
             .catch(error => {
                 console.error('Error deleting card via modal:', error);
                 alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ —Å–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∫–∞—Ä—Ç–æ—á–∫–∏.');
             });
         });
         */

    } // end if(cardDetailModalEl)

    // --- –õ–æ–≥–∏–∫–∞ –¥–ª—è Drag-and-Drop ---
    const cardLists = document.querySelectorAll('.card-list');
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º CSRF-—Ç–æ–∫–µ–Ω, –ø–æ–ª—É—á–µ–Ω–Ω—ã–π —Ä–∞–Ω–µ–µ
    const csrfTokenForDrag = csrfToken; // –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–∫–µ–Ω

    cardLists.forEach(list => {
        Sortable.create(list, {
            group: 'cards',
            animation: 150,
            ghostClass: 'sortable-ghost', // –ö–ª–∞—Å—Å –¥–ª—è "–ø—Ä–∏–∑—Ä–∞–∫–∞" –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–µ–º–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞
            chosenClass: 'sortable-chosen', // –ö–ª–∞—Å—Å –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞
            dragClass: 'sortable-drag', // –ö–ª–∞—Å—Å –¥–ª—è –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–µ–º–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞
            draggable: '.draggable-card',
            onEnd: function (evt) {
                const itemEl = evt.item; // –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–µ–º—ã–π —ç–ª–µ–º–µ–Ω—Ç (–∫–∞—Ä—Ç–æ—á–∫–∞)
                const toList = evt.to;   // –°–ø–∏—Å–æ–∫, –∫—É–¥–∞ –ø–µ—Ä–µ–º–µ—Å—Ç–∏–ª–∏
                const fromList = evt.from; // –°–ø–∏—Å–æ–∫, –æ—Ç–∫—É–¥–∞ –ø–µ—Ä–µ–º–µ—Å—Ç–∏–ª–∏
                const oldIndex = evt.oldDraggableIndex; // –°—Ç–∞—Ä—ã–π –∏–Ω–¥–µ–∫—Å –≤ `fromList`

                const cardId = itemEl.getAttribute('data-card-id');
                const newColumnId = toList.getAttribute('data-column-id');

                // –û–±–Ω–æ–≤–ª—è–µ–º –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä—ã "–ù–µ—Ç –∫–∞—Ä—Ç–æ—á–µ–∫" —Å—Ä–∞–∑—É
                updateNoCardsPlaceholder(toList);
                updateNoCardsPlaceholder(fromList);

                const payload = {
                    new_column_id: newColumnId
                    // –°—é–¥–∞ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å new_index: evt.newDraggableIndex, –µ—Å–ª–∏ –Ω—É–∂–Ω–∞ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –Ω–∞ –±—ç–∫–µ
                };

                if (!csrfTokenForDrag) {
                    console.error('CSRF token not found for drag-and-drop operation.');
                    alert('–û—à–∏–±–∫–∞: CSRF —Ç–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
                    // –í–µ—Ä–Ω—É—Ç—å —ç–ª–µ–º–µ–Ω—Ç –æ–±—Ä–∞—Ç–Ω–æ –≤–∏–∑—É–∞–ª—å–Ω–æ
                    fromList.insertBefore(itemEl, fromList.children[oldIndex]);
                    updateNoCardsPlaceholder(toList);
                    updateNoCardsPlaceholder(fromList);
                    return;
                }

                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª–æ–∂–µ–Ω–∏—è
                fetch(`/api/cards/${cardId}/move`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfTokenForDrag
                    },
                    body: JSON.stringify(payload)
                })
                .then(response => {
                    if (!response.ok) {
                        // –ï—Å–ª–∏ –æ—à–∏–±–∫–∞, –ø—ã—Ç–∞–µ–º—Å—è –ø—Ä–æ—á–∏—Ç–∞—Ç—å JSON —Å –æ—à–∏–±–∫–æ–π
                        return response.json().then(errData => {
                            throw new Error(errData.error || `Request failed with status ${response.status}`);
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    if (!data.success) {
                        // –ï—Å–ª–∏ API –≤–µ—Ä–Ω—É–ª–æ –æ—à–∏–±–∫—É success=false
                        console.error('Failed to move card (API):', data.error);
                        // –í–µ—Ä–Ω—É—Ç—å —ç–ª–µ–º–µ–Ω—Ç –æ–±—Ä–∞—Ç–Ω–æ –≤–∏–∑—É–∞–ª—å–Ω–æ
                        fromList.insertBefore(itemEl, fromList.children[oldIndex]);
                        updateNoCardsPlaceholder(toList);
                        updateNoCardsPlaceholder(fromList);
                        alert('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è –∫–∞—Ä—Ç–æ—á–∫–∏: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                    }
                    // –ï—Å–ª–∏ —É—Å–ø–µ—Ö, –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º, —ç–ª–µ–º–µ–Ω—Ç —É–∂–µ –≤–∏–∑—É–∞–ª—å–Ω–æ –ø–µ—Ä–µ–º–µ—â–µ–Ω
                })
                .catch(error => {
                    console.error('Error during fetch for card move:', error);
                    // –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞, –≤–µ—Ä–Ω—É—Ç—å —ç–ª–µ–º–µ–Ω—Ç –æ–±—Ä–∞—Ç–Ω–æ
                    fromList.insertBefore(itemEl, fromList.children[oldIndex]);
                    updateNoCardsPlaceholder(toList);
                    updateNoCardsPlaceholder(fromList);
                    alert('–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–∏ –∫–∞—Ä—Ç–æ—á–∫–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É. (' + error.message + ')');
                });
            }
        });
    });

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä–∞ "–ù–µ—Ç –∫–∞—Ä—Ç–æ—á–µ–∫"
    function updateNoCardsPlaceholder(listElement) {
        if (!listElement) return;
        let placeholder = listElement.querySelector('.no-cards-placeholder');
        const cardsInList = listElement.querySelectorAll('.draggable-card').length;

        if (cardsInList === 0) {
            if (!placeholder) {
                placeholder = document.createElement('div');
                placeholder.className = 'list-group-item text-muted small fst-italic no-cards-placeholder';
                placeholder.textContent = '–ù–µ—Ç –∫–∞—Ä—Ç–æ—á–µ–∫';
                listElement.appendChild(placeholder);
            }
            placeholder.style.display = 'block';
        } else {
            if (placeholder) {
                placeholder.style.display = 'none'; // –°–∫—Ä—ã–≤–∞–µ–º –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä, –µ—Å–ª–∏ –∫–∞—Ä—Ç–æ—á–∫–∏ –µ—Å—Ç—å
            }
        }
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä–æ–≤ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    cardLists.forEach(list => {
        updateNoCardsPlaceholder(list);
    });

});
</script>
{% endblock %}
