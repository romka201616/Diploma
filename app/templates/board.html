{% extends "base.html" %}
{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h1>{{ board.name }}</h1>
    <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">–ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É –¥–æ—Å–æ–∫</a>
</div>

<div class="container-fluid">
    <div class="row flex-nowrap overflow-auto pb-3">
        {% for column in columns %}
        <div class="col-md-4 col-lg-3">
            <div class="card bg-light mb-3 h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 me-2">{{ column.name }}</h5>
                    <div class="d-flex align-items-center">
                         <a href="{{ url_for('edit_column', column_id=column.id) }}" class="btn btn-sm btn-outline-secondary border-0 p-1 me-1" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ–ª–æ–Ω–∫—É">‚úèÔ∏è</a>
                         <form action="{{ url_for('delete_column', column_id=column.id) }}" method="post" onsubmit="return confirm('–£–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∫–æ–ª–æ–Ω–∫—É \'{{ column.name }}\'? –í—Å–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –≤ –Ω–µ–π –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã!');" class="d-inline">
                            <button type="submit" class="btn btn-sm btn-outline-danger border-0 p-1" title="–£–¥–∞–ª–∏—Ç—å –∫–æ–ª–æ–Ω–∫—É">‚úñ</button>
                        </form>
                    </div>
                </div>
                <div class="card-body d-flex flex-column">
                    <div class="list-group list-group-flush mb-3 flex-grow-1">
                        {% for card in column.cards.all() %}
                        <div class="list-group-item list-group-item-action card-item-clickable py-2 px-3"
                             data-bs-toggle="modal"
                             data-bs-target="#cardDetailModal"
                             data-card-id="{{ card.id }}"
                             data-card-title="{{ card.title }}"
                             data-card-description="{{ card.description or '' }}"
                             data-edit-url="{{ url_for('edit_card', card_id=card.id) }}"
                             data-delete-url="{{ url_for('delete_card', card_id=card.id) }}">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">{{ card.title }}</h6>
                            </div>
                            {% if card.description %}
                                <small class="text-muted">–ï—Å—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ üìÑ</small>
                            {% endif %}
                        </div>
                        {% else %}
                            <p class="text-muted small fst-italic px-3">–ù–µ—Ç –∫–∞—Ä—Ç–æ—á–µ–∫</p>
                        {% endfor %}
                    </div>
                    <form action="{{ url_for('create_card', column_id=column.id) }}" method="post" novalidate class="mt-auto">
                        {{ card_form.hidden_tag() }}
                        <div class="input-group input-group-sm mb-2">
                            {{ card_form.title(class="form-control", placeholder="–ù–æ–≤–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞...", aria_label="–ó–∞–≥–æ–ª–æ–≤–æ–∫ –∫–∞—Ä—Ç–æ—á–∫–∏") }}
                        </div>
                        {{ card_form.submit_card(class="btn btn-outline-primary w-100", value="–î–æ–±–∞–≤–∏—Ç—å") }}
                    </form>
                </div>
            </div>
        </div>
        {% endfor %}

        <div class="col-md-4 col-lg-3">
            <div class="card bg-light">
                <div class="card-body">
                    <form action="{{ url_for('view_board', board_id=board.id) }}" method="post" novalidate>
                        {{ column_form.hidden_tag() }}
                         <div class="mb-2">
                            {{ column_form.name.label(class="form-label visually-hidden") }}
                            {{ column_form.name(class="form-control form-control-sm" + (" is-invalid" if column_form.errors.name else ""), placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–π –∫–æ–ª–æ–Ω–∫–∏") }}
                            {% if column_form.name.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in column_form.name.errors %}<span>{{ error }}</span><br>{% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        {{ column_form.submit_column(class="btn btn-primary btn-sm w-100", value="–î–æ–±–∞–≤–∏—Ç—å –∫–æ–ª–æ–Ω–∫—É") }}
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–µ—Ç–∞–ª–µ–π/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–∞—Ä—Ç–æ—á–∫–∏ -->
<div class="modal fade" id="cardDetailModal" tabindex="-1" aria-labelledby="cardDetailModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="cardDetailModalLabel">–î–µ—Ç–∞–ª–∏ –∫–∞—Ä—Ç–æ—á–∫–∏</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="editCardFormModal" method="post" action="">
            {{ card_form.hidden_tag() }} {# –ò—Å–ø–æ–ª—å–∑—É–µ–º CSRF –æ—Ç –æ–±—â–µ–π —Ñ–æ—Ä–º—ã, –µ—Å–ª–∏ –æ–Ω–∞ –ø–µ—Ä–µ–¥–∞–Ω–∞, –∏–ª–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–≤–æ–π #}
            <div class="mb-3">
                <label for="modalCardTitle" class="form-label">–ó–∞–≥–æ–ª–æ–≤–æ–∫ –∫–∞—Ä—Ç–æ—á–∫–∏</label>
                <input type="text" class="form-control" id="modalCardTitle" name="title" required maxlength="150">
            </div>
            <div class="mb-3">
                <label for="modalCardDescription" class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                <textarea class="form-control" id="modalCardDescription" name="description" rows="5" maxlength="1000"></textarea>
            </div>
            <input type="submit" name="submit_card" style="display:none;"> {# –î–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å CardForm button name #}
        </form>
        <div id="cardStaticDetails" class="d-none">
            <h5 id="staticCardTitle"></h5>
            <p id="staticCardDescription" style="white-space: pre-wrap;"></p>
        </div>
      </div>
      <div class="modal-footer justify-content-between">
        <div>
            <form id="deleteCardFormModal" method="post" action="" class="d-inline" onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É?');">
                 <button type="submit" class="btn btn-danger">–£–¥–∞–ª–∏—Ç—å</button>
            </form>
        </div>
        <div>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
            <button type="submit" class="btn btn-primary" form="editCardFormModal">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    var cardDetailModal = document.getElementById('cardDetailModal');
    if (cardDetailModal) {
        var modalForm = document.getElementById('editCardFormModal');
        var modalTitleField = document.getElementById('modalCardTitle');
        var modalDescriptionField = document.getElementById('modalCardDescription');
        var modalLabel = document.getElementById('cardDetailModalLabel');
        var deleteForm = document.getElementById('deleteCardFormModal');

        var staticTitle = document.getElementById('staticCardTitle');
        var staticDescription = document.getElementById('staticCardDescription');
        var cardDetailsDiv = document.getElementById('cardStaticDetails');


        cardDetailModal.addEventListener('show.bs.modal', function (event) {
            var cardElement = event.relatedTarget;
            var cardId = cardElement.getAttribute('data-card-id');
            var cardTitle = cardElement.getAttribute('data-card-title');
            var cardDescription = cardElement.getAttribute('data-card-description');
            var editUrl = cardElement.getAttribute('data-edit-url');
            var deleteUrl = cardElement.getAttribute('data-delete-url');

            modalLabel.textContent = '–ö–∞—Ä—Ç–æ—á–∫–∞: ' + cardTitle;
            
            modalTitleField.value = cardTitle;
            modalDescriptionField.value = cardDescription;
            modalForm.action = editUrl;
            
            deleteForm.action = deleteUrl;

            // –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç–∏—á–µ—Å–∫—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é (–º–æ–∂–Ω–æ —É–±—Ä–∞—Ç—å –µ—Å–ª–∏ –Ω–µ –Ω—É–∂–Ω–æ)
            // staticTitle.textContent = cardTitle;
            // staticDescription.textContent = cardDescription;
            // cardDetailsDiv.classList.remove('d-none'); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –±–ª–æ–∫
            // modalForm.classList.add('d-none'); // –°–∫—Ä—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        });

        // –ï—Å–ª–∏ –≤—ã —Ö–æ—Ç–∏—Ç–µ –æ—Ç–¥–µ–ª—å–Ω—ã–π —Ä–µ–∂–∏–º –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ,
        // –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å" –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ, –∫–æ—Ç–æ—Ä–∞—è –±—É–¥–µ—Ç
        // –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç—å –≤–∏–¥–∏–º–æ—Å—Ç—å —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö –∏ —Ñ–æ—Ä–º—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.
        // –î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã, –∑–¥–µ—Å—å —Ñ–æ—Ä–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å—Ä–∞–∑—É –∞–∫—Ç–∏–≤–Ω–∞.
    }
});
</script>
{% endblock %}