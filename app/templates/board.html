{% extends "base.html" %}
{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h1>{{ board.name }} <small class="text-muted fs-6">(–í–ª–∞–¥–µ–ª–µ—Ü: {{ board.owner.username }})</small></h1>
    <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">–ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É –¥–æ—Å–æ–∫</a>
</div>

<!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–∞–º–∏ (—Ç–æ–ª—å–∫–æ –¥–ª—è –≤–ª–∞–¥–µ–ª—å—Ü–∞) -->
{% if is_owner %}
<div class="card mb-4">
    <div class="card-header">
        –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–∞–º–∏
    </div>
    <div class="card-body">
        <h5>–ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h5>
        <form action="{{ url_for('invite_to_board', board_id=board.id) }}" method="post" novalidate class="row g-3 align-items-end">
            {{ invite_form.hidden_tag() }}
            <div class="col-md-6">
                {{ invite_form.email_or_username.label(class="form-label") }}
                {{ invite_form.email_or_username(class="form-control form-control-sm" + (" is-invalid" if invite_form.email_or_username.errors else "")) }}
                {% if invite_form.email_or_username.errors %}
                    <div class="invalid-feedback d-block">
                        {% for error in invite_form.email_or_username.errors %}<span>{{ error }}</span><br>{% endfor %}
                    </div>
                {% endif %}
            </div>
            <div class="col-auto">
                {{ invite_form.submit_invite(class="btn btn-sm btn-success") }}
            </div>
        </form>
        <hr>
        <h5>–¢–µ–∫—É—â–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏:</h5>
        {% if board_members %}
            <ul class="list-group list-group-flush">
                {% for member in board_members %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    {{ member.username }} ({{ member.email }})
                    {% if member != board.owner %} {# –ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å –≤–ª–∞–¥–µ–ª—å—Ü–∞ –∏–∑ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ #}
                    <form action="{{ url_for('remove_from_board', board_id=board.id, user_id=member.id) }}" method="post" onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å {{ member.username }} —Å —ç—Ç–æ–π –¥–æ—Å–∫–∏?');" class="d-inline">
                        <button type="submit" class="btn btn-sm btn-outline-warning">–£–¥–∞–ª–∏—Ç—å</button>
                    </form>
                    {% else %}
                    <span class="badge bg-primary">–í–ª–∞–¥–µ–ª–µ—Ü</span>
                    {% endif %}
                </li>
                {% endfor %}
            </ul>
        {% else %}
            <p class="text-muted">–ö—Ä–æ–º–µ –≤–∞—Å, –Ω–∞ –¥–æ—Å–∫–µ –ø–æ–∫–∞ –Ω–µ—Ç –¥—Ä—É–≥–∏—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤.</p>
        {% endif %}
    </div>
</div>
{% endif %}


<div class="container-fluid px-0"> {# –£–±—Ä–∞–ª px-0 –µ—Å–ª–∏ –Ω–µ –Ω—É–∂–Ω–æ #}
    <div class="row flex-nowrap overflow-auto pb-3" id="boardColumnsContainer">
        {% for column in columns %}
        <div class="col-md-4 col-lg-3 column-drag-container">
            <div class="card bg-light mb-3 h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 me-2">{{ column.name }}</h5>
                    {% if current_user.can_edit_board(board) %} {# –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å/—É–¥–∞–ª—è—Ç—å –∫–æ–ª–æ–Ω–∫–∏ –º–æ–≥—É—Ç –≤—Å–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏ #}
                    <div class="d-flex align-items-center">
                         <a href="{{ url_for('edit_column', column_id=column.id) }}" class="btn btn-sm btn-outline-secondary border-0 p-1 me-1" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ–ª–æ–Ω–∫—É">‚úèÔ∏è</a>
                         <form action="{{ url_for('delete_column', column_id=column.id) }}" method="post" onsubmit="return confirm('–£–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∫–æ–ª–æ–Ω–∫—É \'{{ column.name }}\'? –í—Å–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –≤ –Ω–µ–π –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã!');" class="d-inline">
                            <button type="submit" class="btn btn-sm btn-outline-danger border-0 p-1" title="–£–¥–∞–ª–∏—Ç—å –∫–æ–ª–æ–Ω–∫—É">‚úñ</button>
                        </form>
                    </div>
                    {% endif %}
                </div>
                <div class="card-body d-flex flex-column">
                    <div class="list-group list-group-flush mb-3 flex-grow-1 card-list" id="column-{{ column.id }}" data-column-id="{{ column.id }}">
                        {% for card in column.cards.all() %}
                        <div class="list-group-item list-group-item-action card-item-clickable py-2 px-3 draggable-card"
                             data-bs-toggle="modal"
                             data-bs-target="#cardDetailModal"
                             data-card-id="{{ card.id }}"
                             data-card-title="{{ card.title }}"
                             data-card-description="{{ card.description or '' }}"
                             data-edit-url="{{ url_for('edit_card', card_id=card.id) }}"
                             data-delete-url="{{ url_for('delete_card', card_id=card.id) }}">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">{{ card.title }}</h6>
                            </div>
                            {% if card.description %}
                                <small class="text-muted">–ï—Å—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ üìÑ</small>
                            {% endif %}
                        </div>
                        {% else %}
                            <div class="list-group-item text-muted small fst-italic no-cards-placeholder">–ù–µ—Ç –∫–∞—Ä—Ç–æ—á–µ–∫</div>
                        {% endfor %}
                    </div>
                    {% if current_user.can_edit_board(board) %} {# –î–æ–±–∞–≤–ª—è—Ç—å –∫–∞—Ä—Ç–æ—á–∫–∏ –º–æ–≥—É—Ç –≤—Å–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏ #}
                    <form action="{{ url_for('create_card', column_id=column.id) }}" method="post" novalidate class="mt-auto">
                        {{ card_form.hidden_tag() }}
                        <div class="input-group input-group-sm mb-2">
                            {{ card_form.title(class="form-control", placeholder="–ù–æ–≤–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞...", aria_label="–ó–∞–≥–æ–ª–æ–≤–æ–∫ –∫–∞—Ä—Ç–æ—á–∫–∏") }}
                        </div>
                        {{ card_form.submit_card(class="btn btn-outline-primary w-100", value="–î–æ–±–∞–≤–∏—Ç—å") }}
                    </form>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}

        {% if current_user.can_edit_board(board) %} {# –î–æ–±–∞–≤–ª—è—Ç—å –∫–æ–ª–æ–Ω–∫–∏ –º–æ–≥—É—Ç –≤—Å–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏ #}
        <div class="col-md-4 col-lg-3">
            <div class="card bg-light">
                <div class="card-body">
                    <form action="{{ url_for('view_board', board_id=board.id) }}" method="post" novalidate>
                        {{ column_form.hidden_tag() }}
                         <div class="mb-2">
                            {{ column_form.name.label(class="form-label visually-hidden") }}
                            {{ column_form.name(class="form-control form-control-sm" + (" is-invalid" if column_form.errors.name else ""), placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–π –∫–æ–ª–æ–Ω–∫–∏") }}
                            {% if column_form.name.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in column_form.name.errors %}<span>{{ error }}</span><br>{% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        {{ column_form.submit_column(class="btn btn-primary btn-sm w-100", value="–î–æ–±–∞–≤–∏—Ç—å –∫–æ–ª–æ–Ω–∫—É") }}
                    </form>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–µ—Ç–∞–ª–µ–π/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–∞—Ä—Ç–æ—á–∫–∏ (–∫–æ–¥ –æ—Å—Ç–∞–ª—Å—è –ø—Ä–µ–∂–Ω–∏–º) -->
<div class="modal fade" id="cardDetailModal" tabindex="-1" aria-labelledby="cardDetailModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="cardDetailModalLabel">–î–µ—Ç–∞–ª–∏ –∫–∞—Ä—Ç–æ—á–∫–∏</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="editCardFormModal" method="post" action="">
            {{ card_form.hidden_tag() }} {# CSRF token from the main card_form instance #}
            <div class="mb-3">
                <label for="modalCardTitle" class="form-label">–ó–∞–≥–æ–ª–æ–≤–æ–∫ –∫–∞—Ä—Ç–æ—á–∫–∏</label>
                <input type="text" class="form-control" id="modalCardTitle" name="title" required maxlength="150">
            </div>
            <div class="mb-3">
                <label for="modalCardDescription" class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                <textarea class="form-control" id="modalCardDescription" name="description" rows="5" maxlength="1000"></textarea>
            </div>
            <input type="submit" name="submit_card" style="display:none;"> {# For compatibility with CardForm submit button name #}
        </form>
      </div>
      <div class="modal-footer justify-content-between">
        <div>
            <form id="deleteCardFormModal" method="post" action="" class="d-inline" onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É?');">
                 <button type="submit" class="btn btn-danger">–£–¥–∞–ª–∏—Ç—å</button>
            </form>
        </div>
        <div>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
            <button type="submit" class="btn btn-primary" form="editCardFormModal">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }} {# For Bootstrap JS from base.html #}
<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js" integrity="sha512-Eezs+g9Lq4TCCq0wae01s9PuNWzHYoCMkE97e2qdkYthpI0pzC3UGB03lgEHn2XM85hDOUF6qgqqszs+iXU4UA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    var cardDetailModalEl = document.getElementById('cardDetailModal');
    if (cardDetailModalEl) {
        var modalForm = document.getElementById('editCardFormModal');
        var modalTitleField = document.getElementById('modalCardTitle');
        var modalDescriptionField = document.getElementById('modalCardDescription');
        var modalLabel = document.getElementById('cardDetailModalLabel');
        var deleteForm = document.getElementById('deleteCardFormModal');
        // –ü–æ–ø—ã—Ç–∫–∞ –ø–æ–ª—É—á–∏—Ç—å CSRF —Ç–æ–∫–µ–Ω –∏–∑ —Ñ–æ—Ä–º—ã –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞, —Ç–∞–∫ –∫–∞–∫ –æ–Ω–∞ –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –≤ —à–∞–±–ª–æ–Ω
        var csrfToken = modalForm.querySelector('input[name="csrf_token"]').value;


        cardDetailModalEl.addEventListener('show.bs.modal', function (event) {
            var cardElement = event.relatedTarget;
            // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ —Å–æ–±—ã—Ç–∏–µ –≤—ã–∑–≤–∞–Ω–æ –∫–∞—Ä—Ç–æ—á–∫–æ–π
            if (!cardElement || !cardElement.classList.contains('draggable-card')) return; 

            var cardId = cardElement.getAttribute('data-card-id');
            var cardTitle = cardElement.getAttribute('data-card-title');
            var cardDescription = cardElement.getAttribute('data-card-description');
            var editUrl = cardElement.getAttribute('data-edit-url');
            var deleteUrl = cardElement.getAttribute('data-delete-url');

            modalLabel.textContent = '–ö–∞—Ä—Ç–æ—á–∫–∞: ' + cardTitle;
            modalTitleField.value = cardTitle;
            modalDescriptionField.value = cardDescription;
            modalForm.action = editUrl;
            deleteForm.action = deleteUrl;
            
            let deleteCsrfInput = deleteForm.querySelector('input[name="csrf_token"]');
            if (!deleteCsrfInput) {
                deleteCsrfInput = document.createElement('input');
                deleteCsrfInput.type = 'hidden';
                deleteCsrfInput.name = 'csrf_token';
                deleteForm.appendChild(deleteCsrfInput);
            }
            deleteCsrfInput.value = csrfToken; // –ò—Å–ø–æ–ª—å–∑—É–µ–º CSRF —Ç–æ–∫–µ–Ω –∏–∑ –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ–æ—Ä–º—ã –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
        });
    }

    const cardLists = document.querySelectorAll('.card-list');
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º CSRF-—Ç–æ–∫–µ–Ω, –ø–æ–ª—É—á–µ–Ω–Ω—ã–π —Ä–∞–Ω–µ–µ –∏–∑ —Ñ–æ—Ä–º—ã –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    const csrfTokenForDrag = document.querySelector('#editCardFormModal input[name="csrf_token"]')?.value;

    cardLists.forEach(list => {
        Sortable.create(list, {
            group: 'cards',
            animation: 150,
            ghostClass: 'sortable-ghost',
            draggable: '.draggable-card', // –¢–æ–ª—å–∫–æ —ç–ª–µ–º–µ–Ω—Ç—ã —Å —ç—Ç–∏–º –∫–ª–∞—Å—Å–æ–º –º–æ–∂–Ω–æ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞—Ç—å
            onEnd: function (evt) {
                const itemEl = evt.item;
                const toList = evt.to;
                const fromList = evt.from;

                const cardId = itemEl.getAttribute('data-card-id');
                const newColumnId = toList.getAttribute('data-column-id');

                updateNoCardsPlaceholder(toList);
                updateNoCardsPlaceholder(fromList);

                const payload = {
                    new_column_id: newColumnId
                };
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è CSRF —Ç–æ–∫–µ–Ω–∞ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
                if (!csrfTokenForDrag) {
                    console.error('CSRF token not found for drag-and-drop operation.');
                    alert('–û—à–∏–±–∫–∞: CSRF —Ç–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
                    // –í–µ—Ä–Ω—É—Ç—å —ç–ª–µ–º–µ–Ω—Ç –æ–±—Ä–∞—Ç–Ω–æ
                    fromList.insertBefore(itemEl, fromList.children[evt.oldDraggableIndex]);
                    updateNoCardsPlaceholder(toList);
                    updateNoCardsPlaceholder(fromList);
                    return;
                }

                fetch(`/api/cards/${cardId}/move`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfTokenForDrag
                    },
                    body: JSON.stringify(payload)
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(errData => {
                            throw new Error(errData.error || `Request failed with status ${response.status}`);
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        // console.log('Card moved successfully via API');
                    } else {
                        console.error('Failed to move card (API):', data.error);
                        fromList.insertBefore(itemEl, fromList.children[evt.oldDraggableIndex]);
                        updateNoCardsPlaceholder(toList);
                        updateNoCardsPlaceholder(fromList);
                        alert('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è –∫–∞—Ä—Ç–æ—á–∫–∏: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                    }
                })
                .catch(error => {
                    console.error('Error during fetch for card move:', error);
                    fromList.insertBefore(itemEl, fromList.children[evt.oldDraggableIndex]);
                    updateNoCardsPlaceholder(toList);
                    updateNoCardsPlaceholder(fromList);
                    alert('–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–∏ –∫–∞—Ä—Ç–æ—á–∫–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É. (' + error.message + ')');
                });
            }
        });
    });

    function updateNoCardsPlaceholder(listElement) {
        if (!listElement) return;
        let placeholder = listElement.querySelector('.no-cards-placeholder');
        const cardsInList = listElement.querySelectorAll('.draggable-card').length;

        if (cardsInList === 0) {
            if (!placeholder) {
                placeholder = document.createElement('div');
                placeholder.className = 'list-group-item text-muted small fst-italic no-cards-placeholder';
                placeholder.textContent = '–ù–µ—Ç –∫–∞—Ä—Ç–æ—á–µ–∫';
                listElement.appendChild(placeholder);
            }
            placeholder.style.display = 'block';
        } else {
            if (placeholder) {
                placeholder.style.display = 'none';
            }
        }
    }
    
    cardLists.forEach(list => {
        updateNoCardsPlaceholder(list);
    });

});
</script>
{% endblock %}